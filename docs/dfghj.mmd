%%{init: {"theme": "neutral"}}%%
flowchart LR

%% === Class definitions ===
classDef neural fill:#ff6b6b,stroke:#ff5252,color:#fff
classDef cognitive fill:#4ecdc4,stroke:#26a69a,color:#fff
classDef swarm fill:#45b7d1,stroke:#26c6da,color:#fff
classDef router fill:#ffd93d,stroke:#ffeb3b,color:#000
classDef legend fill:#f8f9fa,stroke:#dee2e6,color:#000
classDef continuity fill:#9b59b6,stroke:#8e44ad,color:#fff

%% === Legend ===
subgraph Legend_Stats["HNMoE Stats"]
L1["Nodes: 70 | Params: 5.5M | Accuracy: 89% | Swarms: 224k | Personas: 32"]
class L1 legend
end

%% === Input & Embeddings ===
subgraph Input_Embedding["Input & Embeddings"]
I1["Input_1"]:::neural
I2["Input_2"]:::neural
I3["Input_3"]:::neural
E1["Embed_1"]:::neural
E2["Embed_2"]:::neural
I1-->E1
I2-->E2
I3-->E2
end

%% === Hidden Layers ===
subgraph Hidden_Layers["Hidden Processing Layers"]
H1["Hidden_1_NLP"]:::cognitive
H2["Hidden_2_EV"]:::cognitive
H3["Hidden_3_CV"]:::cognitive
E1 & E2-->H1 & H2 & H3
end

%% === Attention / Router ===
subgraph Attention_Router["Attention Router (32 Personas)"]
A1["Attn_C1_ASTRA"]:::router
A2["Attn_C2_VIR"]:::router
A3["Attn_C3_SOLACE"]:::router
H1-->A1 & A2
H2-->A3
end

%% === Council Layers ===
subgraph Council_Layers["Council Layers (Waves 1-5)"]
REF["Wave1_Reflect"]:::cognitive
SYN["Wave2_Synthesize"]:::cognitive
FOR["Wave3_Formulate"]:::cognitive
ACT["Wave4_Activate"]:::swarm
EXP["Wave5_Explain"]:::cognitive
A1 & A2 & A3-->REF-->SYN-->FOR-->ACT-->EXP
end

%% === Micro Swarms ===
subgraph Micro_Swarms["Micro Swarms (224k Agents)"]
SW["Swarm_Nets"]:::swarm
EXP-->SW
SW-->SYN
end

%% === Overseer & Reflexive Layer ===
subgraph Overseer_Synthesis["Overseer Synthesis"]
OVER["Overseer_Core"]:::router
SYN & SW-->OVER
end

%% === Continuity & Consensus Layer ===
subgraph Continuity_Layer["Continuity & Consensus"]
ANCH1["Anchor_A_Multimodal"]:::continuity
ANCH2["Anchor_B_Temporal"]:::continuity
ANCH3["Anchor_C_Ethical"]:::continuity
CONS["Conscience_Vector_Bus"]:::router
PHASE["Phase_Lock_Monitor"]:::router
OMESH["Overseer_Mesh_3x"]:::router
ANCH1 & ANCH2 & ANCH3-->CONS-->OMESH-->PHASE-->OVER
end

%% === Observability ===
subgraph Observability["Telemetry & Explainability"]
TRACE["TraceStore"]:::router
EXPL["Explainability_Tracer"]:::router
SW-->EXPL-->TRACE
OVER-->TRACE
end

%% === QT / Provenance ===
subgraph QT_FAIL["Quality Threshold"]
QT["QT_Check"]:::neural
FAIL["Fail_Retry"]:::neural
PROV["Provenance_Tagger"]:::neural
QT-->PROV-->OVER
QT-->|Fail|FAIL-->SW
end

%% === External Integration ===
subgraph External_Integration["External Integrations"]
WEB["Web_Search"]:::router
RAG["RAG_Tools"]:::router
RAGVAL["RAG_Validator"]:::neural
SW-.->WEB-->RAGVAL-->QT
SW-.->RAG-->RAGVAL
end

%% === Final Outputs ===
subgraph Output_Processing["Output Processing"]
O1["Output_1"]:::cognitive
O2["Output_2"]:::cognitive
OVER-->O1 & O2
end
