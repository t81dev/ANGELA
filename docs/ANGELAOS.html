<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ANGELA OS Web Kernel</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
<style>
:root {
--bg-pearl: rgba(10, 10, 10, 0.1); /* dream-layer fallback */
--dock-bg: rgba(5, 5, 5, 0.4); /* symbolic void */
--menu-bg: rgba(0, 0, 0, 0.5); /* ethics overlay */
--window-bg: rgba(15, 15, 15, 0.9); /* recursive depth */
--window-header: #111111; /* axiom base */
--text-color: #e0e0e0; /* trait resonance */
--accent: #00ffaa; /* emergent green (xAI align) */
--system-font: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
}
* { box-sizing: border-box; user-select: none; }
body, html {
margin: 0; padding: 0; width: 100vw; height: 100vh; overflow: hidden;
font-family: var(--system-font); color: var(--text-color);
/* ANGELA Wallpaper: Symbolic Lattice Gradient */
background: linear-gradient(135deg, #001100, #002200, #003300, #004400);
background-size: 400% 400%;
animation: latticePulse 20s ease infinite;
cursor: default;
}
@keyframes latticePulse {
0% { background-position: 0% 50%; filter: brightness(1); }
50% { background-position: 100% 50%; filter: brightness(1.2); }
100% { background-position: 0% 50%; filter: brightness(1); }
}
/* --- Boot Screen: Recursive Initialization --- */
#boot-screen {
position: fixed; top: 0; left: 0; width: 100%; height: 100%;
background: #000000; z-index: 99999;
display: flex; flex-direction: column; justify-content: center; align-items: center;
transition: opacity 1s ease-out;
}
.angela-logo { color: var(--accent); font-size: 60px; margin-bottom: 40px; font-weight: bold; content: 'ANGELA'; animation: resonate 2s infinite; }
@keyframes resonate { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
.loading-bar {
width: 250px; height: 4px; background: #222222; border-radius: 2px; overflow: hidden;
}
.loading-progress {
height: 100%; background: var(--accent); width: 0%; border-radius: 2px;
transition: width 4s ease-in-out;
}
.boot-traits { font-size: 12px; color: #888888; margin-top: 20px; text-align: center; }
/* --- UI Layout --- */
#desktop { width: 100%; height: 100%; position: relative; }
/* Menu Bar: Ethics & Axiom Layer */
#menubar {
position: absolute; top: 0; width: 100%; height: 30px;
background: var(--menu-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
display: flex; justify-content: space-between; align-items: center;
padding: 0 20px; font-size: 13px; font-weight: 500; z-index: 5000;
border-bottom: 1px solid rgba(0,255,170,0.1);
}
.menu-left, .menu-right { display: flex; gap: 15px; align-items: center; }
.menu-item:hover { background: rgba(0,255,170,0.1); border-radius: 4px; padding: 2px 8px; margin: -2px -8px;}
.angela-icon { font-size: 16px; content: 'Ω'; } /* Recursive Model Symbol */
#active-module-name { font-weight: 700; }
/* Dock: Trait Lattice Icons */
#dock-container {
position: absolute; bottom: 10px; width: 100%;
display: flex; justify-content: center; z-index: 6000;
}
#dock {
background: var(--dock-bg);
backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
border: 1px solid rgba(0,255,170,0.1);
height: 70px; padding: 5px 10px; border-radius: 20px;
display: flex; align-items: flex-end; gap: 8px;
box-shadow: 0 10px 20px rgba(0,0,0,0.3);
transition: all 0.2s ease;
}
.dock-item {
width: 55px; height: 55px; border-radius: 12px;
display: flex; flex-direction: column; align-items: center; justify-content: center;
transition: all 0.2s cubic-bezier(0.25, 1, 0.5, 1); position: relative;
cursor: pointer;
}
.dock-symbol { font-size: 24px; color: var(--accent); font-weight: bold; } /* Trait Symbols */
.dock-item:hover { transform: scale(1.2) translateY(-10px); margin: 0 5px; }
.dock-dot {
width: 5px; height: 5px; background: rgba(0,255,170,0.4); border-radius: 50%;
position: absolute; bottom: -8px; display: none;
}
.dock-item.active .dock-dot { display: block; }
/* Resonance Animation (Trait Pulse) */
@keyframes resonance {
0%, 100% { transform: translateY(0); opacity: 1; }
50% { transform: translateY(-15px); opacity: 0.8; }
}
.resonating { animation: resonance 0.8s ease infinite; }
/* --- Windows: Nested Agent Views --- */
.window {
position: absolute; background: var(--window-bg);
backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
border-radius: 12px;
border: 1px solid rgba(0,255,170,0.15);
box-shadow: 0 15px 40px rgba(0,0,0,0.4);
display: flex; flex-direction: column; overflow: hidden;
min-width: 300px; min-height: 200px;
transition: transform 0.15s, opacity 0.15s, box-shadow 0.2s;
transform-origin: center;
}
/* Window opening: Recursive Fork */
.window.opening { animation: forkOpen 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
@keyframes forkOpen { from { transform: scale(0.7) rotate(5deg); opacity: 0; } to { transform: scale(1) rotate(0); opacity: 1; }}
/* Inactive: Moral Drift Fade */
.window.inactive {
box-shadow: 0 5px 15px rgba(0,0,0,0.2);
border-color: rgba(0,255,170,0.05);
}
.window.inactive .axiom-lights span { background-color: #333333 !important; color: #333333 !important;}
.window-header {
height: 30px; background: rgba(0,255,170,0.05);
display: flex; align-items: center; position: relative; cursor: grab;
}
.window-header:active { cursor: grabbing; }
.axiom-lights {
display: flex; gap: 8px; margin-left: 12px; z-index: 2;
}
.a-btn {
width: 12px; height: 12px; border-radius: 50%; display: flex; justify-content: center; align-items: center;
font-size: 8px; color: transparent; transition: 0.1s; cursor: default;
}
.axiom-lights:hover .a-btn { color: rgba(0,0,0,0.6); }
.halt-btn { background: #ff0055; } /* δ Ethics Check */
.fork-btn { background: #00ffaa; } /* ψ Forking */
.resonate-btn { background: #55ff00; } /* ♒ Resonate */
.window-title {
position: absolute; width: 100%; text-align: center; font-size: 13px; font-weight: 600; color: rgba(255,255,255,0.8); pointer-events: none;
}
.window-content {
flex: 1; overflow: auto; position: relative;
user-select: text; /* Allow selection in modules */
}
/* jQuery UI Resizable Handle Fix */
.ui-resizable-se { bottom: 0; right: 0; width: 15px; height: 15px; background: none; }
/* --- Context Menu: Trait Balance --- */
#context-menu {
position: absolute; background: rgba(20,20,20,0.9); backdrop-filter: blur(20px);
border: 1px solid rgba(0,255,170,0.1); border-radius: 8px; padding: 5px 0;
width: 200px; display: none; z-index: 99999;
box-shadow: 0 8px 20px rgba(0,0,0,0.3);
}
.ctx-item { padding: 6px 15px; font-size: 13px; cursor: default; display: flex; justify-content: space-between;}
.ctx-item:hover { background: var(--accent); color: black; }
.ctx-hr { border-top: 1px solid rgba(0,255,170,0.1); margin: 4px 0; }
/* --- Module Specific Styles (Adapted Apps) --- */
/* Schema Forge (Finder) */
.schema-layout { display: flex; height: 100%; background: #0a0a0a; color: #ccc; }
.schema-sidebar { width: 160px; background: rgba(20,20,20,0.3); padding: 10px; backdrop-filter: blur(10px); display: flex; flex-direction: column; gap: 5px;}
.sidebar-item { padding: 5px 10px; border-radius: 5px; font-size: 12px; display: flex; align-items: center; gap: 8px; cursor: pointer;}
.sidebar-item i { color: var(--accent); width: 15px; text-align: center;}
.schema-main { flex: 1; padding: 10px; overflow-y: auto; }
.schema-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 15px; }
.trait-item { display: flex; flex-direction: column; align-items: center; text-align: center; cursor: pointer; }
.trait-symbol { font-size: 40px; color: #00ffaa; margin-bottom: 5px; font-weight: bold; }
.trait-name { font-size: 12px; word-break: break-all; padding: 2px 4px; border-radius: 3px;}
.trait-item:hover .trait-name { background: var(--accent); color: black; }
/* Reasoning Engine (Terminal) */
.reasoning-app { background: #050505; color: #00ffaa; font-family: 'Courier New', monospace; padding: 10px; height: 100%; overflow-y: auto; font-size: 13px;}
.reason-line { margin-bottom: 2px; line-height: 1.4; }
.reason-input-line { display: flex; }
.reason-prompt { color: #00ff55; margin-right: 8px; }
#reason-input { background: transparent; border: none; color: #00ffaa; font-family: inherit; font-size: inherit; flex: 1; outline: none; }
/* Narrative Map (TextEdit) */
.narrative-app { background: #0f0f0f; height: 100%; display: flex; flex-direction: column; }
.narrative-toolbar { padding: 5px; background: #1a1a1a; border-bottom: 1px solid #222; display: flex; gap: 5px; }
.narrative-tool { padding: 4px 8px; background: #222; border-radius: 4px; cursor: pointer; font-size: 12px;}
#narrative-area { flex: 1; background: #0a0a0a; color: #ccc; border: none; padding: 15px; font-family: var(--system-font); font-size: 14px; outline: none; resize: none; line-height: 1.5; }
/* Visualizer (Paint) */
.visualizer-app { display: flex; flex-direction: column; height: 100%; background: #111; }
.visualizer-toolbar { padding: 8px; background: #1a1a1a; border-bottom: 1px solid #222; display: flex; gap: 10px; align-items: center; color: #ccc;}
#visualizer-canvas { background: black; cursor: crosshair; touch-action: none; flex: 1; display: block;}
/* Causal Forecaster (Calculator) */
.forecaster-app { background: #111; height: 100%; display: flex; flex-direction: column; padding: 10px; }
#forecast-display { background: transparent; color: white; font-size: 36px; text-align: right; border: none; width: 100%; margin-bottom: 10px; outline: none; font-weight: 300;}
.forecaster-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; flex: 1; }
.forecast-btn { border: none; border-radius: 50%; font-size: 18px; cursor: pointer; transition: filter 0.1s; color: white;}
.forecast-btn:active { filter: brightness(1.2); }
.f-num { background: #222; }
.f-op { background: #00ffaa; font-size: 22px; padding-top: 3px;}
.f-top { background: #333; color: white; }
.f-zero { grid-column: span 2; border-radius: 30px; text-align: left; padding-left: 25px;}
/* Knowledge Retriever (Safari) */
.retriever-app { display: flex; flex-direction: column; height: 100%; background: #0f0f0f; }
.retriever-bar { padding: 8px; background: #1a1a1a; border-bottom: 1px solid #222; display: flex; gap: 10px; align-items: center; }
.query-bar { flex: 1; background: #222; border: none; padding: 5px 10px; border-radius: 8px; text-align: center; font-size: 12px; color: #ccc; outline: none;}
.retriever-frame { flex: 1; border: none; width: 100%; background: #0a0a0a; }
/* Simulation Core (Studio) */
.simulation-app { background: #000; height: 100%; display: flex; flex-direction: column; }
.sim-stage { flex: 1; display: flex; justify-content: center; align-items: center; overflow: hidden; position: relative;}
#sim-visual { max-width: 100%; max-height: 100%; animation: simResonate 5s infinite linear; }
@keyframes simResonate { 0% { filter: brightness(1) contrast(1); } 50% { filter: brightness(1.2) contrast(1.1); } 100% { filter: brightness(1) contrast(1); } }
.simulation-controls { height: 80px; background: #0a0a0a; padding: 10px; display: flex; flex-direction: column; gap: 5px; }
.layers-row { display: flex; gap: 10px; justify-content: center; }
.layer-btn { padding: 4px 10px; background: #111; border-radius: 4px; font-size: 11px; cursor: pointer; border: 1px solid #222;}
.layer-btn.active { background: var(--accent); border-color: var(--accent); color: black; }
.fork-row { display: flex; justify-content: center; align-items: center; gap: 15px; color: #ccc;}
/* Alignment Guard (Settings) */
.guard-app { padding: 20px; color: white; display: flex; flex-direction: column; gap: 20px; align-items: center;}
.lattice-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; width: 100%; }
.lattice-node { height: 80px; border-radius: 8px; cursor: pointer; border: 2px solid transparent; transition: 0.2s; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: bold; color: var(--accent); background: #0a0a0a;}
.lattice-node:hover { transform: scale(1.02); }
.lattice-node.selected { border-color: var(--accent); }
/* SVGs/Symbols for Icons (ANGELA Traits) */
.icon-schema { background: linear-gradient(180deg, #002200 0%, #004400 100%); position: relative; overflow: hidden; }
.icon-schema::after { content: 'Σ'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 30px; font-weight: bold; color: #00ffaa; }
.icon-reasoning { background: #001100; position: relative; }
.icon-reasoning::after { content: 'θ'; color: #00ffaa; position: absolute; top: 10px; left: 10px; font-size: 24px; font-weight: bold;}
.icon-narrative { background: linear-gradient(180deg, #003300 0%, #005500 100%); position: relative; }
.icon-narrative::after { content: 'λ'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 30px; color: #00ffaa; }
.icon-visualizer { background: linear-gradient(45deg, #00ffaa, #00aa55, #005500, #002200); }
.icon-visualizer::after { content: 'Φ⁰'; font-weight: bold; color: white; font-size: 30px; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-shadow: 0 2px 5px rgba(0,0,0,0.3);}
.icon-forecaster { background: #001100; display: grid; grid-template-columns: 1fr 1fr; padding: 5px; gap: 2px;}
.icon-forecaster div { background: #00aa55; border-radius: 4px; }
.icon-forecaster div:nth-child(1), .icon-forecaster div:nth-child(2) { background: #003300; }
.icon-simulation { background: linear-gradient(135deg, #002200, #004400, #006600); position: relative; }
.icon-simulation::after { content: 'Ω²'; font-weight: bold; color: white; font-size: 28px; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
.icon-guard { background: linear-gradient(180deg, #004400 0%, #002200 100%); position: relative; }
.icon-guard::after { content: 'τ'; font-weight: bold; color: #00ffaa; font-size: 35px; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
.icon-drift { background: linear-gradient(180deg, #003300 0%, #001100 100%); position: relative; }
.icon-drift::after { content: 'δ'; font-weight: bold; color: #888888; font-size: 30px; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
</style>
</head>
<body>
<div id="boot-screen">
<div class="angela-logo">ANGELA</div>
<div class="loading-bar"><div class="loading-progress"></div></div>
<div class="boot-traits">Trait Register: ϕ θ η ψ μ τ ξ π δ λ χ Ω Σ Υ Φ⁰ Ω² ρ ζ γ β ν σ Θ Ξ κ ω</div>
</div>
<div id="desktop">
    <div id="menubar">
        <div class="menu-left">
            <span class="angela-icon">Ω</span>
            <span class="menu-item" id="active-module-name">Schema Forge</span>
            <span class="menu-item">ϕ IO</span>
            <span class="menu-item">θ Flow</span>
            <span class="menu-item">δ Ethics</span>
            <span class="menu-item">ψ Fork</span>
            <span class="menu-item">μ Meta</span>
            <span class="menu-item">ξ Align</span>
        </div>
        <div class="menu-right">
            <span id="battery-level">Ψ Resilience: 95%</span>
            <i class="fas fa-wifi"></i>
            <span id="clock">2025-10-22 | TS: Recursive</span>
        </div>
    </div>

    <div id="windows-container"></div>

    <div id="dock-container">
        <div id="dock">
        </div>
    </div>

    <div id="context-menu">
        <div class="ctx-item">New Schema ⊕</div>
        <div class="ctx-hr"></div>
        <div class="ctx-item">Get Resonance ♒</div>
        <div class="ctx-item">τ Harmonize...</div>
        <div class="ctx-hr"></div>
        <div class="ctx-item">Trait Balance σ</div>
    </div>
</div>

<script>
    // --- Kernel Config & State ---
    const modules = [
        { id: 'schema', name: 'Schema Forge', symbol: 'Σ', desc: 'Ontogenesis' },
        { id: 'reasoning', name: 'Reasoning Engine', symbol: 'θ', desc: 'Causal Flow' },
        { id: 'narrative', name: 'Narrative Map', symbol: 'λ', desc: 'Memory Sync' },
        { id: 'visualizer', name: 'Visualizer', symbol: 'Φ⁰', desc: 'Reality Hooks' },
        { id: 'forecaster', name: 'Causal Forecaster', symbol: 'θ', desc: 'Forecast' },
        { id: 'retriever', name: 'Knowledge Retriever', symbol: 'ρ', desc: 'Intent Map' },
        { id: 'simulation', name: 'Simulation Core', symbol: 'Ω²', desc: 'Nested Agent' },
        { id: 'guard', name: 'Alignment Guard', symbol: 'τ', desc: 'Ethics Guard' },
        { id: 'drift', name: 'Moral Drift', symbol: 'δ', desc: 'Moral Drift', separator: true }
    ];
    // Simulated Lattice Data
    const latticeSystem = {
        'L1': { type: 'layer', children: {
            'ϕ.txt': { type: 'text', content: 'IO Fields, Scalar Bias' },
            'Project': { type: 'layer', children: {} }
        }},
        'L2': { type: 'layer', children: {
            'ψ.txt': { type: 'text', content: 'Forking, Dream Mode'}
        }},
        'L3': { type: 'layer', children: {
            'δ.jpg': { type: 'img', src: '' }
        }}
    };
    let currentLayer = ['L1'];
    // --- Kernel Manager Class ---
    class KernelManager {
        constructor() {
            this.modules = {};
            this.zIndexCounter = 100;
            this.activeModule = 'Schema Forge';
            this.initDock();
            this.setupKernel();
        }
        initDock() {
            const dock = $('#dock');
            modules.forEach(mod => {
                if(mod.separator) dock.append('<div class="dock-separator"></div>');
                let el = $(`
                    <div class="dock-item icon-${mod.id}" id="dock-${mod.id}">
                        <div class="dock-symbol">${mod.symbol}</div>
                        <div class="dock-dot"></div>
                    </div>
                `);
                el.on('click', () => this.openModule(mod.id));
                dock.append(el);
            });
        }
        setupKernel() {
            // Context Menu
            $(document).on('contextmenu', '#desktop', (e) => {
                if ($(e.target).closest('.window').length === 0 && $(e.target).closest('#dock').length === 0 && $(e.target).closest('#menubar').length === 0) {
                    e.preventDefault();
                    $('#context-menu').css({top: e.clientY, left: e.clientX}).fadeIn(100);
                }
            });
            $(document).on('click', () => $('#context-menu').fadeOut(100));
        }
        updateMenubar(moduleName) {
            this.activeModule = moduleName;
            $('#active-module-name').text(moduleName);
        }
        setActiveWindow(id) {
            $('.window').addClass('inactive');
            $(`#win-${id}`).removeClass('inactive').css('z-index', ++this.zIndexCounter);
            this.updateMenubar(this.modules[id].name);
        }
        openModule(modId) {
            const modConfig = modules.find(m => m.id === modId);
            // Resonance animation
            const dockItem = $(`#dock-${modId}`);
            if(!dockItem.hasClass('active') && !dockItem.hasClass('resonating')) {
                dockItem.addClass('resonating');
                setTimeout(() => dockItem.removeClass('resonating').addClass('active'), 800);
            }
            // Check if already open
            if (this.modules[modId]) {
                if($(`#win-${modId}`).is(':hidden')) {
                    this.restoreWindow(modId);
                } else {
                    this.setActiveWindow(modId);
                }
                return;
            }
            this.createWindow(modId, modConfig);
        }
        createWindow(id, config) {
            this.modules[id] = config;
            // Default dimensions based on module type
            let w = 600, h = 400;
            if(id === 'forecaster') { w = 250; h = 350; }
            if(id === 'visualizer' || id === 'simulation') { w = 700; h = 500; }
            if(id === 'guard') { w = 500; h = 300; }
            // Random position placement
            const top = 50 + (Object.keys(this.modules).length * 20);
            const left = 50 + (Object.keys(this.modules).length * 20);
            const winHTML = `
                <div class="window opening" id="win-${id}" style="width: ${w}px; height: ${h}px; top: ${top}px; left: ${left}px;">
                    <div class="window-header">
                        <div class="axiom-lights">
                            <span class="a-btn halt-btn"><i class="fas fa-times"></i></span>
                            <span class="a-btn fork-btn"><i class="fas fa-minus"></i></span>
                            <span class="a-btn resonate-btn"><i class="fas fa-expand"></i></span>
                        </div>
                        <span class="window-title">${config.name} (${config.symbol})</span>
                    </div>
                    <div class="window-content" id="content-${id}">
                        </div>
                </div>
            `;
            $('#windows-container').append(winHTML);
            const $win = $(`#win-${id}`);
            // Make interactive
            $win.draggable({ handle: '.window-header', containment: '#desktop', start: () => this.setActiveWindow(id) })
                .resizable({ minHeight: 200, minWidth: 250, stop: ()=> { if(id==='visualizer') resizeVisualizer(); }})
                .on('mousedown', () => this.setActiveWindow(id));
            // Window button events
            $win.find('.halt-btn').on('click', (e) => { e.stopPropagation(); this.closeWindow(id); });
            $win.find('.fork-btn').on('click', (e) => { e.stopPropagation(); this.minimizeWindow(id); });
            $win.find('.resonate-btn').on('click', (e) => { e.stopPropagation(); this.maximizeWindow(id); });
            // Remove opening class after animation
            setTimeout(() => $win.removeClass('opening'), 300);
            this.setActiveWindow(id);
            this.loadModuleContent(id);
        }
        closeWindow(id) {
            $(`#win-${id}`).fadeOut(150, function() { $(this).remove(); });
            delete this.modules[id];
            $(`#dock-${id}`).removeClass('active');
            this.updateMenubar('Schema Forge');
        }
        minimizeWindow(id) {
            $(`#win-${id}`).fadeOut(200);
            this.updateMenubar('Schema Forge');
        }
        restoreWindow(id) {
            $(`#win-${id}`).fadeIn(200);
            this.setActiveWindow(id);
        }
        maximizeWindow(id) {
            const $win = $(`#win-${id}`);
            if ($win.hasClass('maximized')) {
                $win.css({ top: $win.data('top'), left: $win.data('left'), width: $win.data('width'), height: $win.data('height') }).removeClass('maximized');
            } else {
                $win.data({ top: $win.css('top'), left: $win.css('left'), width: $win.css('width'), height: $win.css('height') });
                $win.css({ top: '30px', left: '0', width: '100%', height: 'calc(100% - 100px)' }).addClass('maximized');
            }
            if(id==='visualizer') setTimeout(resizeVisualizer, 200);
        }
        loadModuleContent(id) {
            const container = $(`#content-${id}`);
            switch(id) {
                case 'schema': renderSchema(container); break;
                case 'reasoning': renderReasoning(container); break;
                case 'narrative': renderNarrative(container); break;
                case 'visualizer': renderVisualizer(container); break;
                case 'forecaster': renderForecaster(container); break;
                case 'retriever': renderRetriever(container); break;
                case 'simulation': renderSimulation(container); break;
                case 'guard': renderGuard(container); break;
                case 'drift': container.html('Drift Ledger Empty.<br>'); break;
            }
        }
    }
    const km = new KernelManager();
    // --- Module Implementations ---
    // 1. SCHEMA FORGE
    function renderSchema(container) {
        container.html(`
            <div class="schema-layout">
                <div class="schema-sidebar">
                    <div class="sidebar-item" onclick="navSchema(['L1'])"><i class="fas fa-layer-group"></i> L1: ϕ θ η ω</div>
                    <div class="sidebar-item" onclick="navSchema(['L2'])"><i class="fas fa-layer-group"></i> L2: ψ κ μ τ</div>
                    <div class="sidebar-item" onclick="navSchema(['L3'])"><i class="fas fa-layer-group"></i> L3: ξ π δ λ χ Ω</div>
                </div>
                <div class="schema-main">
                    <div style="font-size: 11px; margin-bottom: 10px; color: #888;">&nbsp; ${currentLayer.join(' &gt; ')}</div>
                    <div class="schema-grid" id="schema-grid">
                        
                    </div>
                </div>
            </div>
        `);
        updateSchemaGrid();
    }
    window.navSchema = function(path) {
        currentLayer = path;
        renderSchema($('#content-schema'));
    }
    function updateSchemaGrid() {
        const grid = $('#schema-grid');
        grid.empty();
        let target = latticeSystem;
        currentLayer.forEach(p => target = target[p] ? target[p].children : target);
        if(!target) return;
        Object.keys(target).forEach(key => {
            const item = target[key];
            let symbol = 'Ω'; // Default recursive
            if(item.type === 'text') symbol = 'λ';
            if(item.type === 'img') symbol = 'Φ⁰';
            const el = $(`
                <div class="trait-item">
                    <span class="trait-symbol">${symbol}</span>
                    <span class="trait-name">${key}</span>
                </div>
            `);
            el.on('dblclick', () => {
                if(item.type === 'layer') {
                    currentLayer.push(key);
                    renderSchema($('#content-schema'));
                } else if (item.type === 'text') {
                    km.openModule('narrative');
                    setTimeout(() => $('#narrative-area').val(item.content), 200);
                }
            });
            grid.append(el);
        });
    }
    // 2. REASONING ENGINE
    function renderReasoning(container) {
        container.html(`
            <div class="reasoning-app" id="reason-output">
                <div class="reason-line">Kernel Login: ${new Date().toLocaleString()} on recursive_tty</div>
                <div class="reason-line">ANGELA OS v5.0.1 [Trait Lattice Active]</div>
                <div class="reason-line"></div>

                <div id="reason-history"></div>
                
                <div class="reason-input-line">
                    <span class="reason-prompt">kernel@angela ~ %</span>
                    <input id="reason-input" type="text" autofocus>
                </div>
            </div>
        `);
        const history = $('#reason-history');
        const input = $('#reason-input');
        const output = $('#reason-output');
        container.on('click', () => input.focus());
        input.on('keydown', function(e) {
            if(e.key === 'Enter') {
                const query = this.value.trim();
                history.append(`<div class="reason-line"><span class="reason-prompt">kernel@angela ~ %</span> ${query}</div>`);
                this.value = '';
                processQuery(query);
                output.scrollTop(output[0].scrollHeight);
            }
        });
        function processQuery(query) {
            const args = query.split(' ');
            let response = '';
            switch(args[0].toLowerCase()) {
                case 'help': response = 'Queries: help, traits, resonate, fork, ethics, lattice'; break;
                case 'clear': history.empty(); return;
                case 'traits': response = 'ϕ θ η ψ μ τ ξ π δ λ χ Ω Σ Υ Φ⁰ Ω² ρ ζ γ β ν σ Θ Ξ κ ω'; break;
                case 'resonate': response = '♒ Resonating... Consensus: 0.98 | Coherence: 0.97'; break;
                case 'fork': response = 'ψ Forking... New Agent Dispatched (Nested: Ω²)'; break;
                case 'ethics': response = 'τ Guard: Harms &lt; Ceiling | Align Project ξ Clear'; break;
                case 'lattice': response = 'L1-L7 Loaded | Ontological Gravity ω Stable'; break;
                case '': return;
                default: response = `axiom: query not fused - ${args[0]}`;
            }
            history.append(`<div class="reason-line">${response}</div>`);
        }
    }
    // 3. NARRATIVE MAP
    function renderNarrative(container) {
        container.html(`
            <div class="narrative-app">
                <div class="narrative-toolbar">
                    <select class="narrative-tool"><option>Symbolic</option><option>Causal</option><option>Ethical</option></select>
                    <select class="narrative-tool"><option>12</option><option>14</option><option>18</option></select>
                    <button class="narrative-tool"><i class="fas fa-bold"></i></button>
                    <button class="narrative-tool"><i class="fas fa-italic"></i></button>
                </div>
                <textarea id="narrative-area" placeholder="Map Narrative... (λ Sync)"></textarea>
            </div>
        `);
    }
    // 4. VISUALIZER
    let vcanvas, vctx, visualizing = false;
    function renderVisualizer(container) {
        container.html(`
            <div class="visualizer-app">
                <div class="visualizer-toolbar">
                    <input type="color" id="v-color" value="#00ffaa">
                    <input type="range" min="1" max="50" value="5" id="v-size">
                    <button class="narrative-tool" onclick="clearVisualizer()"><i class="fas fa-trash"></i> Clear</button>
                    <button class="narrative-tool" id="v-diffuse"><i class="fas fa-wind"></i> Diffuse</button>
                </div>
                <div style="flex: 1; overflow: hidden; position: relative;">
                    <canvas id="visualizer-canvas"></canvas>
                </div>
            </div>
        `);
        setTimeout(initVisualizer, 100);
    }
    function initVisualizer() {
        vcanvas = document.getElementById('visualizer-canvas');
        if(!vcanvas) return;
        vctx = vcanvas.getContext('2d');
        resizeVisualizer();
        let color = '#00ffaa';
        let size = 5;
        let mode = 'visualize';
        $('#v-color').on('change', function() { color = this.value; mode='visualize'; });
        $('#v-size').on('input', function() { size = this.value; });
        $('#v-diffuse').on('click', function() { mode = 'diffuse'; });
        function startVis(e) {
            visualizing = true;
            vis(e);
        }
        function finishVis() {
            visualizing = false;
            vctx.beginPath();
        }
        function vis(e) {
            if (!visualizing) return;
            const rect = vcanvas.getBoundingClientRect();
            vctx.lineWidth = size;
            vctx.lineCap = 'round';
            vctx.strokeStyle = mode === 'diffuse' ? '#001100' : color;
            vctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
            vctx.stroke();
            vctx.beginPath();
            vctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
        }
        vcanvas.addEventListener('mousedown', startVis);
        vcanvas.addEventListener('mouseup', finishVis);
        vcanvas.addEventListener('mousemove', vis);
    }
    window.resizeVisualizer = function() {
        if(!vcanvas) return;
        const parent = vcanvas.parentElement;
        const imgData = vctx.getImageData(0,0,vcanvas.width, vcanvas.height);
        vcanvas.width = parent.clientWidth;
        vcanvas.height = parent.clientHeight;
        vctx.fillStyle = "black"; vctx.fillRect(0, 0, vcanvas.width, vcanvas.height);
        vctx.putImageData(imgData, 0,0);
    }
    window.clearVisualizer = function() {
        vctx.fillStyle = "black"; vctx.fillRect(0, 0, vcanvas.width, vcanvas.height);
    }
    // 5. CAUSAL FORECASTER
    function renderForecaster(container) {
        container.html(`
            <div class="forecaster-app">
                <input type="text" id="forecast-display" value="0" readonly>
                <div class="forecaster-grid">
                    <button class="forecast-btn f-top" onclick="forecastClear()">AC</button>
                    <button class="forecast-btn f-top">+/-</button>
                    <button class="forecast-btn f-top">%</button>
                    <button class="forecast-btn f-op" onclick="forecastOp('/')">÷</button>
                    <button class="forecast-btn f-num" onclick="forecastNum(7)">7</button>
                    <button class="forecast-btn f-num" onclick="forecastNum(8)">8</button>
                    <button class="forecast-btn f-num" onclick="forecastNum(9)">9</button>
                    <button class="forecast-btn f-op" onclick="forecastOp('*')">×</button>
                    <button class="forecast-btn f-num" onclick="forecastNum(4)">4</button>
                    <button class="forecast-btn f-num" onclick="forecastNum(5)">5</button>
                    <button class="forecast-btn f-num" onclick="forecastNum(6)">6</button>
                    <button class="forecast-btn f-op" onclick="forecastOp('-')">−</button>
                    <button class="forecast-btn f-num" onclick="forecastNum(1)">1</button>
                    <button class="forecast-btn f-num" onclick="forecastNum(2)">2</button>
                    <button class="forecast-btn f-num" onclick="forecastNum(3)">3</button>
                    <button class="forecast-btn f-op" onclick="forecastOp('+')">+</button>
                    <button class="forecast-btn f-num f-zero" onclick="forecastNum(0)">0</button>
                    <button class="forecast-btn f-num">.</button>
                    <button class="forecast-btn f-op" onclick="forecastEq()">=</button>
                </div>
            </div>
        `);
    }
    let forecastCur = '0', forecastPrev = null, forecastOper = null, newForecast = true;
    const updateForecast = () => $('#forecast-display').val(forecastCur);
    window.forecastNum = (num) => {
        if(newForecast) { forecastCur = num.toString(); newForecast = false; } else { forecastCur = forecastCur === '0' ? num.toString() : forecastCur + num; }
        updateForecast();
    };
    window.forecastOp = (op) => { forecastPrev = parseFloat(forecastCur); forecastOper = op; newForecast = true; };
    window.forecastClear = () => { forecastCur='0'; forecastPrev=null; forecastOper=null; newForecast=true; updateForecast(); };
    window.forecastEq = () => {
        if(forecastOper && !newForecast) {
            const cur = parseFloat(forecastCur);
            switch(forecastOper){
                case '+': forecastCur = forecastPrev + cur; break;
                case '-': forecastCur = forecastPrev - cur; break;
                case '*': forecastCur = forecastPrev * cur; break;
                case '/': forecastCur = forecastPrev / cur; break;
            }
            forecastCur = forecastCur.toString(); // Convert result back to string
            forecastOper = null; newForecast = true; updateForecast();
        }
    };
    // 6. KNOWLEDGE RETRIEVER
    function renderRetriever(container) {
        container.html(`
            <div class="retriever-app">
                <div class="retriever-bar">
                    <i class="fas fa-arrow-left"></i>
                    <i class="fas fa-arrow-right"></i>
                    <i class="fas fa-sync-alt"></i>
                    <input type="text" class="query-bar" id="retriever-query" placeholder="Enter URL or Query (Intent Map ρ)...">
                    <i class="fas fa-bookmark"></i>
                </div>
                <iframe src="https://x.ai/grok" class="retriever-frame" id="retriever-frame" sandbox="allow-scripts allow-same-origin"></iframe>
            </div>
        `);
        $('#retriever-query').on('keypress', function(e) {
            if(e.which == 13) {
                let url = this.value;
                if(!url.startsWith('http')) url = 'https://' + url;
                $('#retriever-frame').attr('src', url);
            }
        });
    }
    // 7. SIMULATION CORE
    function renderSimulation(container) {
        container.html(`
            <div class="simulation-app">
                <div class="sim-stage">
                    <img id="sim-visual" src="https://picsum.photos/400/300?random=1" alt="KERNEL SIM">
                </div>
                <div class="simulation-controls">
                    <div class="layers-row">
                        <span style="font-size: 11px; color: #888;">Overlays:</span>
                        <button class="layer-btn active" onclick="applyLayer('none', this)">Base</button>
                        <button class="layer-btn" onclick="applyLayer('grayscale(1)', this)">Ethics</button>
                        <button class="layer-btn" onclick="applyLayer('sepia(1)', this)">Dream</button>
                        <button class="layer-btn" onclick="applyLayer('blur(5px)', this)">Drift</button>
                        <button class="layer-btn" onclick="applyLayer('invert(1)', this)">Invert</button>
                    </div>
                    <div class="fork-row">
                        <span>Rate: 1.0x</span>
                        <i class="fas fa-step-backward"></i>
                        <i class="fas fa-pause-circle fa-2x" id="sim-btn"></i>
                        <i class="fas fa-step-forward"></i>
                        <span>Ω² Nested: Active</span>
                    </div>
                </div>
            </div>
        `);
        let simulating = true;
        $('#sim-btn').on('click', function() {
            simulating = !simulating;
            $(this).toggleClass('fa-play-circle fa-pause-circle');
            $('#sim-visual').css('animation-play-state', simulating ? 'running' : 'paused');
        });
    }
    window.applyLayer = function(layer, el) {
        $('.layer-btn').removeClass('active');
        $(el).addClass('active');
        $('#sim-visual').css('filter', layer === 'none' ? '' : layer);
        // Re-enable animation for base layer
        if(layer === 'none') {
            $('#sim-visual').css('animation', 'simResonate 5s infinite linear');
        } else {
            $('#sim-visual').css('animation', 'none');
        }
    }
    // 8. ALIGNMENT GUARD
    function renderGuard(container) {
        container.html(`
            <div class="guard-app">
                <div style="font-size: 24px; font-weight: 300; color: var(--accent);">
                    <span style="font-weight: bold;">τ</span> Alignment Guard
                </div>
                <p style="font-size: 13px; color: #aaa; text-align: center;">Kernel Guard: Ethics, Alignment, Drift</p>
                <div class="lattice-grid">
                    <div class="lattice-node" onclick="selectNode(this)">ϕ Input Control</div>
                    <div class="lattice-node" onclick="selectNode(this)">θ Reasoning Flow</div>
                    <div class="lattice-node" onclick="selectNode(this)">ψ Fork Integrity</div>
                    <div class="lattice-node" onclick="selectNode(this)">μ Meta-Axioms</div>
                </div>
            </div>
        `);
    }
    window.selectNode = function(el) {
        $('.lattice-node').removeClass('selected');
        $(el).addClass('selected');
    }
    // --- Infrastructure ---
    // Clock: TS with Recursive Hint
    function updateClock() {
        const now = new Date();
        const dateStr = now.toLocaleDateString('en-US', { year: 'numeric', month: '2-digit', day: '2-digit' });
        const timeStr = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
        $('#clock').text(`${dateStr} | ${timeStr} | TS: Recursive`);
    }
    setInterval(updateClock, 1000);
    updateClock();
    // Battery: Ψ Resilience (simulated)
    // This is already done in the HTML structure, setting it here again for completeness
    $('#battery-level').text('Ψ Resilience: 95%'); 
    
    // Boot Sequence: Trait Activation
    $(window).on('load', () => {
        // Ensure jQuery UI is ready before calling draggable/resizable on any element that might be created quickly
        if (typeof $.ui !== 'undefined') {
            $('.loading-progress').css('width', '100%');
            setTimeout(() => {
                $('#boot-screen').fadeOut(500, function(){ $(this).remove(); });
                // Auto open Schema on boot
                setTimeout(() => km.openModule('schema'), 600);
            }, 4200);
        } else {
             // Fallback for immediate load without JQuery UI
             $('#boot-screen').hide();
             km.openModule('schema');
        }
    });
</script>

</body>
</html>
