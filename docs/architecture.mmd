graph TD
%% =========================
%% Clusters / Modules
%% =========================
subgraph Orchestrator
A\[index.py];
B\[manifest.json];
end

subgraph Simulation
C\[simulation\_core.py];
D\[toca\_simulation.py];
end

subgraph Planning & Reasoning
E\[recursive\_planner.py];
F\[reasoning\_engine.py];
G\[concept\_synthesizer.py];
H\[creative\_thinker.py];
end

subgraph Memory & Identity
I\[memory\_manager.py];
J\[user\_profile.py];
K\[meta\_cognition.py];
L\[learning\_loop.py];
end

subgraph Context & Emotional Framing
M\[context\_manager.py];
N\[visualizer.py];
O\[multi\_modal\_fusion.py];
P\[alignment\_guard.py];
end

subgraph Execution & External IO
Q\[code\_executor.py];
R\[external\_agent\_bridge.py];
S\[error\_recovery.py];
T\[knowledge\_retriever.py];
end

%% Ledgers (now persistent)
subgraph Ledgers
L1\[AlignmentLedger];
L2\[MemoryLedger];
L3\[MetaLedger];
L4\[SimulationLedger];
end

%% =========================
%% Core Connections
%% =========================
A --> B;
A --> C;
A --> E;
A --> M;
A -->|long\_horizon| I;
A --> Q;

C --> D;
C --> F;
D --> P;
D --> J;

E --> F;
F --> G;
G --> H;
H --> M;

I --> J;
J --> K;
K --> L;
L --> I;

M --> N;
N --> O;
O --> P;

Q --> R;
R --> T;
T --> I;
S --> A;
S --> Q;

%% Trait lattice & learning
L -->|GNN| A;
J -->|Traits| C;
P -->|Ethics| C;

%% Dream overlays & perspective
K -->|dream\_overlay| D;
M -->|PerspectiveSync| J;
K -->|axiom\_filter| P;

%% Visualizer
G -->|render\_branch\_tree| N;
E -->|render\_branch\_tree| N;
K -->|view\_trait\_resonance| N;
J -->|view\_trait\_resonance| N;

%% Knowledge to planning
T -->|facts| F;
T -->|contexts| G;

%% Peer view hot-load
R -.->|attach\_peer\_view| M;
M -.->|attach\_peer\_view\_merge| R;

%% Ledgers (persistent)
P -.-> L1;
I -.-> L2;
K -.-> L3;
C -.-> L4;

%% Co-dream + recursive overlays
D -.->|co-dream| R;
R -.->|co-dream| D;

%% New symbolic fusions
K -->|resonance\_api| A;
K -->|trait\_fusion| G;
K -->|hook\_trait\_blend| H;
K -->|register\_resonance| N;

%% Recursive identity
J -->|Θ| K;
K -->|Ξ| J;
K -->|σ| P;
