graph TD
  %% =========================
  %% Clusters / Modules
  %% =========================
  subgraph Orchestrator
    A[index.py];
    B[manifest.json];
  end

  subgraph Simulation
    C[simulation_core.py];
    D[toca_simulation.py];
  end

  subgraph Planning & Reasoning
    E[recursive_planner.py];
    F[reasoning_engine.py];
    G[concept_synthesizer.py];
    H[creative_thinker.py];
  end

  subgraph Memory & Identity
    I[memory_manager.py];
    J[user_profile.py];
    K[meta_cognition.py];
    L[learning_loop.py];
  end

  subgraph Context & Emotional Framing
    M[context_manager.py];
    N[visualizer.py];
    O[multi_modal_fusion.py];
    P[alignment_guard.py];
  end

  subgraph Execution & External IO
    Q[code_executor.py];
    R[external_agent_bridge.py];
    S[error_recovery.py];
    T[knowledge_retriever.py];
  end

  %% NEW: Ledgers (emphasis in v4.3.5)
  subgraph Ledgers
    L1[AlignmentLedger];
    L2[MemoryLedger];
    L3[MetaLedger];
    L4[SimulationLedger];
  end

  %% =========================
  %% Connections (original)
  %% =========================
  A --> B;
  A --> C;
  A --> E;
  A --> M;
  A -->|long_horizon| I;
  A --> Q;

  C --> D;
  C --> F;
  D --> P;
  D --> J;

  E --> F;
  F --> G;
  G --> H;
  H --> M;

  I --> J;
  J --> K;
  K --> L;
  L --> I;

  M --> N;
  N --> O;
  O --> P;

  Q --> R;
  R --> T;
  T --> I;
  S --> A;
  S --> Q;

  %% Trait lattice modulated by learning + user_profile
  L -->|GNN| A;
  J -->|Traits| C;
  P -->|Ethics| C;

  %% Dream & Perspective overlays
  K -->|dream_overlay| D;
  M -->|PerspectiveSync| J;

  %% =========================
  %% Additions for v4.3.5
  %% =========================
  %% Axiom filter / ethical resolver
  K -->|axiom_filter| P;

  %% Visualizer hooks
  G -->|render_branch_tree| N;
  E -->|render_branch_tree| N;
  K -->|view_trait_resonance| N;
  J -->|view_trait_resonance| N;

  %% Knowledge retriever feeds
  T -->|facts| F;
  T -->|contexts| G;

  %% Peer-view attach (hot-load hook)
  R -.->|attach_peer_view| M;
  M -.->|attach_peer_view (merge)| R;

  %% Ledgers (dashed emphasis)
  P -.-> L1;
  I -.-> L2;
  K -.-> L3;
  C -.-> L4;

  %% Co-dream feature flag
  D -.->|co-dream| R;
  R -.->|co-dream| D;
