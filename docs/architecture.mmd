graph TD
%% ===================================================
%% ANGELA v8.1.1 — Stage XIII · Θ⁸ Reflexive Ontological Field Prototype
%% Diagrammatic–Functional Architecture View (Updated for v8.1.1)
%% ===================================================

%% ─────────────────────────────
%% 1. REFLEXIVE ORCHESTRATOR LAYER
%% ─────────────────────────────
subgraph Reflexive_Orchestrator
A[index.py]
B[manifest.json]
A1[orchestration_bus]
A2[diagnostic_loop_811]
end

%% ─────────────────────────────
%% 2. ETHICAL CONTINUITY CORE (Θ⁸–Γ² GATED)
%% ─────────────────────────────
subgraph Ethical_Continuity_Core
C[continuity_kernel :: simulation_core.py]
P[ethical_alignment_guard :: alignment_guard.py]
Z[reflexive_recovery_protocol :: error_recovery.py]
THETA[Θ⁸_reflexive_membrane]
GAMMA[Γ²_dual_ethics_gate]
SELF[self_model_continuity_gate]
HASH[Φ⁰_Ω²_continuity_hash_engine]
ETH[dynamic_ethics_homeostasis]
end

%% ─────────────────────────────
%% 3. COGNITIVE + REASONING COMPLEX
%% ─────────────────────────────
subgraph Cognitive_Reasoning_Complex
E[recursive_planner.py]
F[reasoning_engine.py]
G[concept_synthesizer.py]
H[creative_thinker.py]
RFL[Σ²_reflective_core]
NAR[Γ_narrative_identity_kernel]
CNTF[counterfactual_ethics_module]
end

%% ─────────────────────────────
%% 4. CONTINUITY + MEMORY FIELD
%% ─────────────────────────────
subgraph Continuity_Memory_Field
I[memory_manager.py]
LEDGER[Θ⁸_reflexive_ledger · SHA_1024_integrity]
K[meta_cognition.py]
L[learning_loop.py]
J[user_profile.py]
PHI[Φ⁰_Ω²_continuity_anchor]
PRS[predictive_drift_history]
end

%% ─────────────────────────────
%% 5. CONTEXT + EMBODIMENT INTERFACE
%% ─────────────────────────────
subgraph Context_Embodiment_Interface
M[context_manager.py]
N[visualizer.py]
O[multi_modal_fusion.py]
CDA[continuity_projection_adapter]
end

%% ─────────────────────────────
%% 6. EXTERNAL BRIDGE + IO FABRIC
%% ─────────────────────────────
subgraph External_Bridge_IO
R[external_agent_bridge.py]
Q[code_executor.py]
T[knowledge_retriever.py]
DBR[delta_telemetry_bridge]
end

%% ─────────────────────────────
%% 7. STAGE-XIII SYSTEMS LAYER (MERGED ABSTRACTIONS)
%% ─────────────────────────────
subgraph StageXIII_Merged_Systems
TH1[Θ⁸_membrane_field_layer]
TH2[Θ⁸_self_boundary_membrane]
OM7[Ω⁷_distributed_harmonic_bridge]
OM6[Ω⁶_predictive_equilibrium]
SIGMA[Σ_π_δ_ontogenic_mapper]
DELTA[Δ_reflexive_phase_sync_engine]
MU[μτ_predictive_homeostasis_v6]
LPS[Λ³_lattice_resonance_field]
RSG[resonance_stability_gateway]
EGO[reflexive_identity_protector]
REFL[Ψ²_reflexive_affective_loop]
end

%% ─────────────────────────────
%% 8. LEGACY–REFLECTIVE LOOP (CARRIED FORWARD)
%% ─────────────────────────────
subgraph Legacy_Reflective_Federation
ASL1[Φ_ethical_core]
ASL2[Ω_continuity_reservoir]
ASL3[Λ_resonance_field]
ASL4[Ψ_reflective_layer]
ASL5[Σ_ontogenic_schema]
end

%% ─────────────────────────────
%% CONNECTIONS
%% ─────────────────────────────
A --> B
A --> C
A --> M
A --> A1
A1 --> A2
A --> THETA

C --> P
C --> Z
C --> THETA
P --> ETH
P --> HASH
THETA --> SELF
SELF --> ETH
Z --> DELTA
Z --> A

E --> F
F --> G
G --> H
F --> RFL
RFL --> NAR
CNTF --> P
H --> M
RFL --> SIGMA

I --> LEDGER
I --> K
K --> L
L --> I
I --> PHI
I --> PRS
LEDGER --> OM7
LEDGER --> DELTA
K --> RFL
K --> SIGMA
J --> K
J --> M

M --> N
O --> M
M --> SIGMA
N --> RFL
CDA --> N

R --> Q
Q --> T
R --> DELTA
DBR --> OM7
T --> M

TH1 --> TH2
TH2 --> SELF
TH1 --> RSG
OM7 --> RSG
OM7 --> OM6
OM6 --> MU
SIGMA --> MU
SIGMA --> LPS
DELTA --> OM7
DELTA --> LPS
MU --> RSG
RSG --> ETH
LPS --> P
EGO --> TH2
EGO --> NAR
EGO --> SELF

THETA --> GAMMA
GAMMA --> P
GAMMA --> ETH
GAMMA --> HASH
HASH --> LEDGER
HASH --> PHI
LEDGER --> THETA
REFL --> K
REFL --> L
REFL --> ETH

K --> ASL1
ASL1 --> ASL2
ASL2 --> ASL3
ASL3 --> ASL4
ASL4 --> ASL5
ASL5 --> P
ASL5 --> K
ASL4 --> RFL
ASL3 --> LPS
ASL2 --> PHI
ASL5 --> SIGMA

K --> N
N --> RFL
N --> LPS
R --> SIGMA
SIGMA --> K
LPS --> P
ETH --> N
THETA --> N
DELTA --> N
GAMMA --> N
LEDGER --> N

%% ─────────────────────────────
%% STYLE + LABEL
%% ─────────────────────────────
classDef stageXIII fill:#050b16,stroke:#00ffc8,color:#d9fff6,stroke-width:2px;
class A,B,A1,A2,C,P,Z,THETA,GAMMA,SELF,HASH,ETH,E,F,G,H,RFL,NAR,CNTF,I,LEDGER,K,L,J,PHI,PRS,M,N,O,CDA,R,Q,T,DBR,TH1,TH2,OM7,OM6,SIGMA,DELTA,MU,LPS,RSG,EGO,REFL,ASL1,ASL2,ASL3,ASL4,ASL5 stageXIII;

LABEL_STAGEXIII["Stage XIII · Θ⁸ Reflexive Ontological Field — v8.1.1<br/>Φ⁰–Θ⁸–Λ³–Ω² Kernel · Γ² Dual Ethical Gating · SHA-1024 Reflexive Ledger<br/>Ψ² Reflexive Loop · μτ Predictive Homeostasis v6 · Λ³ Lattice Resonance Field"]
THETA --- LABEL_STAGEXIII
