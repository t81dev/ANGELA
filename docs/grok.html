<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>macOS Web Experience with Grok Integration</title>

<!-- External Libraries via CDN for single-file functionality -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.minrate:1.0.1 !important; margin: 0px; padding: 0px; font-size: 0px; background: rgb(255, 255, 255);"></script>
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">

<style>
    :root {
        --bg-peal: rgba(255, 255, 255, 0.1); /* non-blurred fallback */
        --dock-bg: rgba(20, 20, 20, 0.3);
        --menu-bg: rgba(20, 20, 20, 0.3);
        --window-bg: rgba(30, 30, 32, 0.85);
        --window-header: #2d2d2d;
        --text-color: #ffffff;
        --accent: #007aff;
        --system-font: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    }

    * { box-sizing: border-box; user-select: none; }
    body, html {
        margin: 0; padding: 0; width: 100vw; height: 100vh; overflow: hidden;
        font-family: var(--system-font); color: var(--text-color);
        background: linear-gradient(200deg, #a729f5, #5823d6, #092775, #1d6f9c);
        background-size: 400% 400%;
        animation: gradientBG 15s ease infinite;
        cursor: default;
    }

    @keyframes gradientBG {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }

    /* --- Boot Screen --- */
    #boot-screen {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: #000; z-index: 99999;
        display: flex; flex-direction: column; justify-content: center; align-items: center;
        transition: opacity 1s ease-out;
    }
    .apple-logo { color: white; font-size: 80px; margin-bottom: 40px; }
    .loading-bar {
        width: 200px; height: 6px; background: #333; border-radius: 3px; overflow: hidden;
    }
    .loading-progress {
        height: 100%; background: #fff; width: 0%; border-radius: 3px;
        transition: width 3s ease-in-out;
    }

    /* --- UI Layout --- */
    #desktop { width: 100%; height: 100%; position: relative; }
    
    /* Menu Bar */
    #menubar {
        position: absolute; top: 0; width: 100%; height: 30px;
        background: var(--menu-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
        display: flex; justify-content: space-between; align-items: center;
        padding: 0 20px; font-size: 13px; font-weight: 500; z-index: 5000;
        border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .menu-left, .menu-right { display: flex; gap: 15px; align-items: center; }
    .menu-item { position: relative; }
    .menu-item:hover { background: rgba(255,255,255,0.1); border-radius: 4px; padding: 2px 8px; margin: -2px -8px;}
    .apple-icon { font-size: 16px; }
    #active-app-name { font-weight: 700; }

    /* Dropdown Menus */
    .dropdown {
        position: absolute; top: 30px; left: 0; background: rgba(40,40,40,0.9);
        backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1);
        border-radius: 8px; padding: 5px 0; width: 200px; display: none;
        z-index: 10000; box-shadow: 0 8px 20px rgba(0,0,0,0.3);
    }
    .dropdown-item { padding: 6px 15px; font-size: 13px; cursor: pointer; }
    .dropdown-item:hover { background: var(--accent); color: white; }
    .dropdown-item.disabled { color: #555; pointer-events: none; }
    .dropdown-hr { border-top: 1px solid rgba(255,255,255,0.1); margin: 4px 0; }

    /* Dock */
    #dock-container {
        position: absolute; bottom: 10px; width: 100%;
        display: flex; justify-content: center; z-index: 6000;
    }
    #dock {
        background: var(--dock-bg);
        backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
        border: 1px solid rgba(255,255,255,0.1);
        height: 70px; padding: 5px 10px; border-radius: 20px;
        display: flex; align-items: flex-end; gap: 8px;
        box-shadow: 0 10px 20px rgba(0,0,0,0.3);
 transition: all 0.2s ease;
    }
    .dock-item {
        width: 55px; height: 55px; border-radius: 12px;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        transition: all 0.2s cubic-bezier(0.25, 1, 0.5, 1); position: relative;
        cursor: pointer;
    }
    .dock-icon-svg { width: 100%; height: 100%; border-radius: 14px; }
    
    .dock-item:hover { transform: scale(1.2) translateY(-10px); margin: 0 5px; }
    .dock-dot {
        width: 5px; height: 5px; background: rgba(255,255,255,0.4); border-radius: 50%;
        position: absolute; bottom: -8px; display: none;
    }
    .dock-item.active .dock-dot { display: block; }
    
    @keyframes bounce {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-20px); }
    }
    .bouncing { animation: bounce 0.6s ease infinite; }

    /* Windows System */
    .window {
        position: absolute; background: var(--window-bg);
        backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
        border-radius: 12px;
        border: 1px solid rgba(255,255,255,0.15);
        box-shadow: 0 15px 40px rgba(0,0,0,0.4);
        display: flex; flex-direction: column; overflow: hidden;
        min-width: 300px; min-height: 200px;
        transition: transform 0.15s, opacity 0.15s, box-shadow 0.2s;
        transform-origin: center;
    }
    
    .window.opening { animation: winOpen 0.2s cubic-bezier(0.16, 1, 0.3, 1); }
    @keyframes winOpen { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; }}

    .window.inactive {
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        border-color: rgba(255,255,255,0.05);
    }
    .window.inactive .traffic-lights span { background-color: #555 !important; color: #555 !important;}

    .window-header {
        height: 30px; background: rgba(255,255,255,0.05);
        display: flex; align-items: center; position: relative; cursor: grab;
    }
    .window-header:active { cursor: grabbing; }
    
    .traffic-lights {
        display: flex; gap: 8px; margin-left: 12px; z-index: 2;
    }
    .t-btn {
        width: 12px; height: 12px; border-radius: 50%; display: flex; justify-content: center; align-items: center;
        font-size: 8px; color: transparent; transition: 0.1s; cursor: default;
    }
    .traffic-lights:hover .t-btn { color: rgba(0,0,0,0.6); }
    .close-btn { background: #ff5f56; }
    .min-btn { background: #ffbd2e; }
    .max-btn { background: #27c93f; }

    .window-title {
        position: absolute; width: 100%; text-align: center; font-size: 13px; font-weight: 600; color: rgba(255,255,255,0.8); pointer-events: none;
    }
    .window-content {
        flex: 1; overflow: auto; position: relative;
        user-select: text;
    }

    .ui-resizable-se { bottom: 0; right: 0; width: 15px; height: 15px; background: none; }

    /* Context Menu */
    #context-menu {
        position: absolute; background: rgba(40,40,40,0.9); backdrop-filter: blur(20px);
        border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 5px 0;
        width: 180px; display: none; z-index: 99999;
        box-shadow: 0 8px 20px rgba(0,0,0,0.3);
    }
    .ctx-item { padding: 6px 15px; font-size: 13px; cursor: default; display: flex; justify-content: space-between;}
    .ctx-item:hover { background: var(--accent); color: white; }
    .ctx-hr { border-top: 1px solid rgba(255,255,255,0.1); margin: 4px 0; }

    /* Finder */
    .finder-layout { display: flex; height: 100%; background: #1e1e1e; color: #ddd; }
    .finder-sidebar { width: 140px; background: rgba(50,50,50,0.3); padding: 10px; backdrop-filter: blur(10px); display: flex; flex-direction: column; gap: 5px;}
    .sidebar-item { padding: 5px 10px; border-radius: 5px; font-size: 12px; display: flex; align-items: center; gap: 8px; cursor: pointer;}
    .sidebar-item:hover { background: rgba(255,255,255,0.1); }
    .sidebar-item i { color: var(--accent); width: 15px; text-align: center;}
    .finder-main { flex: 1; padding: 10px; overflow-y: auto; }
    .finder-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 15px; }
    .finder-list { display: flex; flex-direction: column; gap: 5px; }
    .file-item { display: flex; flex-direction: column; align-items: center; text-align: center; cursor: pointer; }
    .file-item.list-view { flex-direction: row; align-items: center; padding: 5px; border-radius: 5px; }
    .file-item.list-view:hover { background: rgba(255,255,255,0.1); }
    .file-icon { font-size: 40px; color: #5dade2; margin-bottom: 5px; }
    .file-icon.list-view { font-size: 20px; margin-right: 10px; }
    .file-icon.folder { color: #5dade2; }
    .file-icon.text { color: #ddd; }
    .file-icon.img { color: #58d68d; }
    .file-name { font-size: 12px; word-break: break-all; padding: 2px 4px; border-radius: 3px;}
    .file-item:hover .file-name { background: var(--accent); }

    /* Terminal */
    .terminal-app { background: #101010; color: #33ff00; font-family: 'Courier New', monospace; padding: 10px; height: 100%; overflow-y: auto; font-size: 13px;}
    .term-line { margin-bottom: 2px; line-height: 1.4; }
    .term-input-line { display: flex; }
    .term-prompt { color: #00bfff; margin-right: 8px; }
    #term-input { background: transparent; border: none; color: #33ff00; font-family: inherit; font-size: inherit; flex: 1; outline: none; }
    
    /* TextEdit */
    .textedit-app { background: #2d2d2d; height: 100%; display: flex; flex-direction: column; }
    .text-toolbar { padding: 5px; background: #3a3a3a; border-bottom: 1px solid #444; display: flex; gap: 5px; }
    .text-tool { padding: 4px 8px; background: #444; border-radius: 4px; cursor: pointer; font-size: 12px;}
    #text-area { flex: 1; background: #1e1e1e; color: #eee; border: none; padding: 15px; font-family: var(--system-font); font-size: 14px; outline: none; resize: none; line-height: 1.5; }
    
    /* Paint */
    .paint-app { display: flex; flex-direction: column; height: 100%; background: #fff; }
    .paint-toolbar { padding: 8px; background: #f0f0f0; border-bottom: 1px solid #ccc; display: flex; gap: 10px; align-items: center; color: #333;}
    #paint-canvas { background: white; cursor: crosshair; touch-action: none; flex: 1; display: block;}
    
    /* Calculator */
    .calc-app { background: #333; height: 100%; display: flex; flex-direction: column; padding: 10px; }
    #calc-display { background: transparent; color: white; font-size: 36px; text-align: right; border: none; width: 100%; margin-bottom: 10px; outline: none; font-weight: 300;}
    .calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; flex: 1; }
    .calc-btn { border: none; border-radius: 50%; font-size: 18px; cursor: pointer; transition: filter 0.1s; color: white;}
    .calc-btn:active { filter: brightness(1.2); }
    .c-num { background: #555; }
    .c-op { background: #ff9f0a; font-size: 22px; padding-top: 3px;}
    .c-top { background: #a5a5a5; color: black; }
    .c-zero { grid-column: span 2; border-radius: 30px; text-align: left; padding-left: 25px;}

    /* Safari */
    .safari-app { display: flex; flex-direction: column; height: 100%; background: #fff; }
    .safari-bar { padding: 8px; background: #f0f0f0; border-bottom: 1px solid #ccc; display: flex; gap: 10px; align-items: center; }
    .url-bar { flex: 1; background: #ddd; border: none; padding: 5px 10px; border-radius: 8px; text-align: center; font-size: 12px; color: #333; outline: none;}
    .safari-frame { flex: 1; border: none; width: 100%; background: white; }

    /* Studio */
    .studio-app { background: #000; height: 100%; display: flex; flex-direction: column; }
    .video-stage { flex: 1; display: flex; justify-content: center; align-items: center; overflow: hidden; position: relative;}
    #main-video { max-width: 100%; max-height: 100%; }
    .studio-controls { height: 80px; background: #1a1a1a; padding: 10px; display: flex; flex-direction: column; gap: 5px; }
    .filters-row { display: flex; gap: 10px; justify-content: center; }
    .filter-btn { padding: 4px 10px; background: #333; border-radius: 4px; font-size: 11px; cursor: pointer; border: 1px solid #444;}
    .filter-btn.active { background: var(--accent); border-color: var(--accent); }
    .playback-row { display: flex; justify-content: center; align-items: center; gap: 15px; color: #ddd;}
    
    /* Settings */
    .settings-app { padding: 20px; color: white; display: flex; flex-direction: column; gap: 20px; align-items: center;}
    .wall-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; width: 100%; }
    .wall-thumb { height: 80px; border-radius: 8px; cursor: pointer; border: 2px solid transparent; transition: 0.2s;}
    .wall-thumb:hover { transform: scale(1.02); }
    .wall-thumb.selected { border-color: var(--accent); }

    /* Grok App */
    .grok-app { display: flex; flex-direction: column; height: 100%; background: #1e1e1e; color: #fff; }
    .grok-toolbar { padding: 8px; background: #2a2a2a; display: flex; gap: 10px; }
    .grok-chat { flex: 1; overflow-y: auto; padding: 15px; }
    .grok-input { padding: 10px; border-top: 1px solid #444; display: flex; gap: 10px; }
    #grok-query { width: 100%; background: #333; color: #fff; border: none; padding: 8px; border-radius: 5px; outline: none; }
    .grok-message { margin-bottom: 10px; padding: 10px; border-radius: 8px; }
    .grok-message.user { background: #007aff; align-self: flex-end; }
    .grok-message.bot { background: #333; }

    /* Icons */
    .icon-finder { background: linear-gradient(180deg, #e3e3e3 0%, #c7c7c7 100%); position: relative; overflow: hidden; }
    .icon-finder::after { content: ':)'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(90deg); font-size: 30px; font-weight: bold; color: #2a62b3; font-family: monospace;}
    .icon-safari { background: white; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%23fff'/%3E%3Ccircle cx='50' cy='50' r='45' fill='%231facfd'/%3E%3Cpath d='M50 5 L50 95 M5 50 L95 50' stroke='rgba(255,255,255,0.3)' stroke-width='1'/%3E%3Cpolygon points='50,10 60,45 90,50 55,60 50,90 40,55 10,50 45,40' fill='white'/%3E%3Cpolygon points='50,10 55,45 50,50 45,45' fill='%23ea4335'/%3E%3C/svg%3E"); background-size: cover;}
    .icon-terminal { background: #222; position: relative; }
    .icon-terminal::after { content: '>_'; color: #fff; position: absolute; top: 10px; left: 10px; font-family: monospace; font-size: 24px; font-weight: bold;}
    .icon-text { background: linear-gradient(180deg, #fdfdfd 0%, #dcdcdc 100%); position: relative; }
    .icon-text::after { content: ''; position: absolute; top: 15px; left: 10px; right: 10px; height: 2px; background: #999; box-shadow: 0 5px 0 #999, 0 10px 0 #999, 0 15px 0 #999; }
    .icon-paint { background: linear-gradient(45deg, #ff3b30, #ff9500, #ffcc00, #4cd964, #5ac8fa, #007aff, #5856d6, #ff2d55); }
    .icon-paint::after { content: '\f1fc'; font-family: 'Font Awesome 6 Free'; font-weight: 900; color: white; font-size: 30px; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-shadow: 0 2px 5px rgba(0,0,0,0.3);}
    .icon-calc { background: #333; display: grid; grid-template-columns: 1fr 1fr; padding: 5px; gap: 2px;}
    .icon-calc div { background: #ff9f0a; border-radius: 4px; }
    .icon-calc div:nth-child(1), .icon-calc div:nth-child(2) { background: #555; }
    .icon-studio { background: linear-gradient(135deg, #3a1c71, #d76d77, #ffaf7b); position: relative; }
    .icon-studio::after { content: '\f008'; font-family: 'Font Awesome 6 Free'; font-weight: 900; color: white; font-size: 28px; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
    .icon-settings { background: linear-gradient(180deg, #8e8e93 0%, #636366 100%); position: relative; }
    .icon-settings::after { content: '\f013'; font-family: 'Font Awesome 6 Free'; font-weight: 900; color: #ddd; font-size: 35px; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
    .icon-trash { background: linear-gradient(180deg, #f2f2f7 0%, #d1d1d6 100%); position: relative; }
    .icon-trash::after { content: '\f1f8'; font-family: 'Font Awesome 6 Free'; font-weight: 900; color: #777; font-size: 30px; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
    .icon-grok { background: linear-gradient(135deg, #00ddeb, #007aff); position: relative; }
    .icon-grok::after { content: '\f3e5'; font-family: 'Font Awesome 6 Free'; font-weight: 900; color: white; font-size: 30px; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
</style>
</head>
<body>

    <!-- Boot Screen -->
    <div id="boot-screen">
        <i class="fab fa-apple apple-logo"></i>
        <div class="loading-bar"><div class="loading-progress"></div></div>
    </div>

    <!-- Desktop Environment -->
    <div id="desktop">
        <!-- Menu Bar -->
        <div id="menubar">
            <div class="menu-left">
                <div class="menu-item"><i class="fab fa-apple apple-icon"></i>
                    <div class="dropdown" id="apple-menu">
                        <div class="dropdown-item" onclick="alert('About macOS Web Edition')">About This Mac</div>
                        <div class="dropdown-hr"></div>
                        <div class="dropdown-item" onclick="wm.openApp('settings')">System Settings</div>
                        <div class="dropdown-item disabled">Recent Items</div>
                        <div class="dropdown-hr"></div>
                        <div class="dropdown-item">Log Out</div>
                    </div>
                </div>
                <div class="menu-item" onclick="wm.openApp('grok')">Grok
                    <div class="dropdown" id="grok-menu">
                        <div class="dropdown-item" onclick="wm.openApp('grok')">New Chat</div>
                        <div class="dropdown-item disabled">Chat History</div>
                    </div>
                </div>
                <div class="menu-item" id="active-app-name">Finder</div>
                <div class="menu-item">File
                    <div class="dropdown" id="file-menu">
                        <div class="dropdown-item" onclick="newFile()">New File</div>
                        <div class="dropdown-item" onclick="newFolder()">New Folder</div>
                        <div class="dropdown-item" onclick="openFile()">Open</div>
                        <div class="dropdown-item" onclick="saveFile()">Save</div>
                        <div class="dropdown-hr"></div>
                        <div class="dropdown-item" onclick="wm.closeWindow(wm.activeApp.toLowerCase())">Close</div>
                    </div>
                </div>
                <div class="menu-item">Edit
                    <div class="dropdown" id="edit-menu">
                        <div class="dropdown-item" onclick="undo()">Undo</div>
                        <div class="dropdown-item" onclick="redo()">Redo</div>
                        <div class="dropdown-hr"></div>
                        <div class="dropdown-item" onclick="copy()">Copy</div>
                        <div class="dropdown-item" onclick="paste()">Paste</div>
                        <div class="dropdown-item" onclick="cut()">Cut</div>
                    </div>
                </div>
                <div class="menu-item">View
                    <div class="dropdown" id="view-menu">
                        <div class="dropdown-item" onclick="setView('grid')">As Icons</div>
                        <div class="dropdown-item" onclick="setView('list')">As List</div>
                        <div class="dropdown-hr"></div>
                        <div class="dropdown-item" onclick="toggleTransparency()">Toggle Transparency</div>
                    </div>
                </div>
                <div class="menu-item">Go
                    <div class="dropdown" id="go-menu">
                        <div class="dropdown-item" onclick="navFinder(['Desktop'])">Desktop</div>
                        <div class="dropdown-item" onclick="navFinder(['Documents'])">Documents</div>
                        <div class="dropdown-item" onclick="navFinder(['Downloads'])">Downloads</div>
                        <div class="dropdown-hr"></div>
                        <div class="dropdown-item disabled">Recent Folders</div>
                    </div>
                </div>
                <div class="menu-item">Window
                    <div class="dropdown" id="window-menu">
                        <div class="dropdown-item" onclick="wm.minimizeAll()">Minimize All</div>
                        <div class="dropdown-item" onclick="wm.maximizeAll()">Zoom All</div>
                        <div class="dropdown-item" onclick="cycleWindows()">Cycle Through Windows</div>
                        <div class="dropdown-hr"></div>
                        <div class="dropdown-item" id="window-list"></div>
                    </div>
                </div>
                <div class="menu-item">Help
                    <div class="dropdown" id="help-menu">
                        <div class="dropdown-item" onclick="wm.openApp('grok')">Ask Grok</div>
                    </div>
                </div>
            </div>
            <div class="menu-right">
                <div class="menu-item"><i class="fas fa-battery-three-quarters"></i> <span id="battery-level">84%</span></div>
                <div class="menu-item"><i class="fas fa-wifi"></i></div>
                <div class="menu-item"><i class="fas fa-search"></i></div>
                <div class="menu-item"><i class="fas fa-sliders-h"></i></div>
                <div class="menu-item" id="clock">Tue Jan 9 9:41 AM</div>
            </div>
        </div>

        <!-- Windows Container -->
        <div id="windows-container"></div>

        <!-- Context Menu -->
        <div id="context-menu">
            <div class="ctx-item" onclick="newFolder()">New Folder</div>
            <div class="ctx-hr"></div>
            <div class="ctx-item">Get Info</div>
            <div class="ctx-item" onclick="wm.openApp('settings')">Change Wallpaper...</div>
            <div class="ctx-hr"></div>
            <div class="ctx-item">Sort By</div>
        </div>

        <!-- Dock -->
        <div id="dock-container">
            <div id="dock"></div>
        </div>
    </div>

<script>
    // System Config & State
    const apps = [
        { id: 'grok', name: 'Grok', iconClass: 'icon-grok' },
        { id: 'finder', name: 'Finder', iconClass: 'icon-finder' },
        { id: 'safari', name: 'Safari', iconClass: 'icon-safari' },
        { id: 'terminal', name: 'Terminal', iconClass: 'icon-terminal' },
        { id: 'textedit', name: 'TextEdit', iconClass: 'icon-text' },
        { id: 'paint', name: 'Sketch', iconClass: 'icon-paint' },
        { id: 'calculator', name: 'Calculator', iconClass: 'icon-calc', htmlIcon: '<div></div><div></div><div></div><div></div>' },
        { id: 'studio', name: 'Studio', iconClass: 'icon-studio' },
        { id: 'settings', name: 'Settings', iconClass: 'icon-settings' },
        { id: 'trash', name: 'Bin', iconClass: 'icon-trash', separator: true }
    ];

    // File System with Persistence
    let fileSystem = JSON.parse(localStorage.getItem('fileSystem')) || {
        'Desktop': { type: 'folder', children: {
            'Welcome.txt': { type: 'text', content: 'Welcome to macOS Web Edition with Grok!\nThis is a simulation built in a single HTML file.'},
            'Project': { type: 'folder', children: {} }
        }},
        'Documents': { type: 'folder', children: {
            'notes.txt': { type: 'text', content: 'Buy milk\nFinish code'}
        }},
        'Downloads': { type: 'folder', children: {
            'image.jpg': { type: 'img', src: '' }
        }}
    };
    let currentPath = ['Desktop'];
    let viewMode = 'grid'; // Default Finder view
    let textEditHistory = []; // Undo/redo stack for TextEdit
    let textEditHistoryIndex = -1;

    function saveFileSystem() {
        localStorage.setItem('fileSystem', JSON.stringify(fileSystem));
    }

    // Window Manager Class
    class WindowManager {
        constructor() {
            this.windows = {};
            this.zIndexCounter = 100;
            this.activeApp = 'Finder';
            this.initDock();
            this.setupDesktop();
            this.setupMenus();
        }

        initDock() {
            const dock = $('#dock');
            apps.forEach(app => {
                if(app.separator) dock.append('<div style="width:1px; height:40px; background:rgba(255,255,255,0.2); margin: 0 5px;"></div>');
                let iconHtml = app.htmlIcon ? app.htmlIcon : '';
                let el = $(`
                    <div class="dock-item" id="dock-${app.id}" title="${app.name}">
                        <div class="dock-icon-svg ${app.iconClass}">${iconHtml}</div>
                        <div class="dock-dot"></div>
                    </div>
                `);
                el.on('click', () => this.openApp(app.id));
                dock.append(el);
            });
        }

        setupDesktop() {
            $(document).on('contextmenu', '#desktop', (e) => {
                if ($(e.target).closest('.window').length === 0 && $(e.target).closest('#dock').length === 0 && $(e.target).closest('#menubar').length === 0) {
                    e.preventDefault();
                    $('#context-menu').css({top: e.clientY, left: e.clientX}).fadeIn(100);
                }
            });
            $(document).on('click', () => {
                $('#context-menu').fadeOut(100);
                $('.dropdown').hide();
            });
        }

        setupMenus() {
            $('.menu-item').on('click', function(e) {
                e.stopPropagation();
                $('.dropdown').hide();
                $(this).find('.dropdown').show();
            });
            $('.dropdown-item').on('click', function(e) {
                e.stopPropagation();
                $('.dropdown').hide();
            });
            // Keyboard navigation for menus
            $('.menu-item').on('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    $(this).find('.dropdown').show();
                    $(this).find('.dropdown-item').first().focus();
                }
            });
            $('.dropdown-item').on('keydown', function(e) {
                if (e.key === 'ArrowDown') {
                    $(this).nextAll('.dropdown-item').first().focus();
                } else if (e.key === 'ArrowUp') {
                    $(this).prevAll('.dropdown-item').first().focus();
                } else if (e.key === 'Enter') {
                    $(this).click();
                }
            });
        }

        updateMenubar(appName) {
            this.activeApp = appName;
            $('#active-app-name').text(appName);
            this.updateWindowMenu();
            this.updateFileMenu();
        }

        updateWindowMenu() {
            const list = $('#window-list');
            list.empty();
            Object.keys(this.windows).forEach(id => {
                list.append(`<div class="dropdown-item" onclick="wm.setActiveWindow('${id}')">${this.windows[id].name}</div>`);
            });
            if (!Object.keys(this.windows).length) {
                list.append('<div class="dropdown-item disabled">No Windows</div>');
            }
        }

        updateFileMenu() {
            const saveItem = $('#file-menu .dropdown-item:contains("Save")');
            saveItem.toggleClass('disabled', !['textedit', 'grok'].includes(this.activeApp.toLowerCase()));
        }

        setActiveWindow(id) {
            $('.window').addClass('inactive');
            $(`#win-${id}`).removeClass('inactive').css('z-index', ++this.zIndexCounter);
            this.updateMenubar(this.windows[id].name);
        }

        openApp(appId) {
            const appConfig = apps.find(a => a.id === appId);
            const dockItem = $(`#dock-${appId}`);
            if(!dockItem.hasClass('active') && !dockItem.hasClass('bouncing')) {
                dockItem.addClass('bouncing');
                setTimeout(() => dockItem.removeClass('bouncing').addClass('active'), 600);
            }
            if (this.windows[appId]) {
                if($(`#win-${appId}`).is(':hidden')) {
                    this.restoreWindow(appId);
                } else {
                    this.setActiveWindow(appId);
                }
                return;
            }
            this.createWindow(appId, appConfig);
        }

        createWindow(id, config) {
            this.windows Spur id] = config;
            let w = 600, h = 400;
            if(id === 'calculator') { w = 250; h = 350; }
            if(id === 'paint' || id === 'studio') { w = 700; h = 500; }
            if(id === 'settings') { w = 500; h = 300; }
            if(id === 'grok') { w = 600; h = 500; }
            const top = 50 + (Object.keys(this.windows).length * 20);
            const left = 50 + (Object.keys(this.windows).length * 20);
            const winHTML = `
                <div class="window opening" id="win-${id}" style="width:${w}px; height:${h}px; top:${top}px; left:${left}px; z-index:${++this.zIndexCounter}">
                    <div class="window-header">
                        <div class="traffic-lights">
                            <div class="t-btn close-btn"><i class="fas fa-times"></i></div>
                            <div class="t-btn min-btn"><i class="fas fa-minus"></i></div>
                            <div class="t-btn max-btn"><i class="fas fa-plus"></i></div>
                        </div>
                        <div class="window-title">${config.name}</div>
                    </div>
                    <div class="window-content" id="content-${id}"></div>
                </div>
            `;
            $('#windows-container').append(winHTML);
            const $win = $(`#win-${id}`);
            $win.draggable({ handle: '.window-header', containment: '#desktop', start: () => this.setActiveWindow(id) })
                .resizable({ minHeight: 200, minWidth: 250, stop: () => { if(id === 'paint') resizeCanvas(); } })
                .on('mousedown', () => this.setActiveWindow(id));
            $win.find('.close-btn').on('click', (e) => { e.stopPropagation(); this.closeWindow(id); });
            $win.find('.min-btn').on('click', (e) => { e.stopPropagation(); this.minimizeWindow(id); });
            $win.find('.max-btn').on('click', (e) => { e.stopPropagation(); this.maximizeWindow(id); });
            setTimeout(() => $win.removeClass('opening'), 200);
            this.setActiveWindow(id);
            this.loadAppContent(id);
        }

        closeWindow(id) {
            $(`#win-${id}`).fadeOut(150, function() { $(this).remove(); });
            delete this.windows[id];
            $(`#dock-${id}`).removeClass('active');
            this.updateMenubar('Finder');
        }

        minimizeWindow(id) {
            $(`#win-${id}`).fadeOut(200);
            this.updateMenubar('Finder');
        }

        restoreWindow(id) {
            $(`#win-${id}`).fadeIn(200);
            this.setActiveWindow(id);
        }

        maximizeWindow(id) {
            const $win = $(`#win-${id}`);
            if ($win.hasClass('maximized')) {
                $win.css({ top: $win.data('top'), left: $win.data('left'), width: $win.data('width'), height: $win.data('height') }).removeClass('maximized');
            } else {
                $win.data({ top: $win.css('top'), left: $win.css('left'), width: $win.css('width'), height: $win.css('height') });
                $win.css({ top: '30px', left: '0', width: '100%', height: 'calc(100% - 100px)' }).addClass('maximized');
            }
            if(id === 'paint') setTimeout(resizeCanvas, 200);
        }

        minimizeAll() {
            Object.keys(this.windows).forEach(id => this.minimizeWindow(id));
        }

        maximizeAll() {
            Object.keys(this.windows).forEach(id => {
                if (!$(`#win-${id}`).hasClass('maximized')) {
                    this.maximizeWindow(id);
                }
            });
        }

        loadAppContent(id) {
            const container = $(`#content-${id}`);
            switch(id) {
                case 'grok': renderGrok(container); break;
                case 'finder': renderFinder(container); break;
                case 'terminal': renderTerminal(container); break;
                case 'textedit': renderTextEdit(container); break;
                case 'paint': renderPaint(container); break;
                case 'calculator': renderCalculator(container); break;
                case 'safari': renderSafari(container); break;
                case 'studio': renderStudio(container); break;
                case 'settings': renderSettings(container); break;
                case 'trash': container.html('<div style="padding:20px; text-align:center; color:#aaa;">Trash is empty.<br><i class="fas fa-trash fa-3x" style="margin-top:20px;"></i></div>'); break;
            }
        }
    }

    const wm = new WindowManager();

    // Menu Functions
    function newFile() {
        let target = fileSystem;
        currentPath.forEach(p => target = target[p].children);
        const fileName = prompt('Enter file name:', 'Untitled.txt');
        if (fileName) {
            target[fileName] = { type: 'text', content: '' };
            saveFileSystem();
            if (wm.activeApp.toLowerCase() === 'finder') {
                renderFinder($('#content-finder'));
            }
        }
    }

    function newFolder() {
        let target = fileSystem;
        currentPath.forEach(p => target = target[p].children);
        const folderName = prompt('Enter folder name:', 'New Folder');
        if (folderName) {
            target[folderName] = { type: 'folder', children: {} };
            saveFileSystem();
            if (wm.activeApp.toLowerCase() === 'finder') {
                renderFinder($('#content-finder'));
            }
        }
    }

    function openFile() {
        if (wm.activeApp.toLowerCase() !== 'finder') return;
        const selected = $('#finder-grid .file-item.selected');
        if (selected.length && selected.find('.file-icon.text').length) {
            const fileName = selected.find('.file-name').text();
            let target = fileSystem;
            currentPath.forEach(p => target = target[p].children);
            wm.openApp('textedit');
            setTimeout(() => $('#text-area').val(target[fileName].content), 200);
        }
    }

    function saveFile() {
        if (!['textedit', 'grok'].includes(wm.activeApp.toLowerCase())) return;
        let content = wm.activeApp.toLowerCase() === 'textedit' ? $('#text-area').val() : $('#grok-query').val();
        let target = fileSystem;
        currentPath.forEach(p => target = target[p].children);
        const fileName = prompt('Enter file name to save:', 'Saved.txt');
        if (fileName) {
            target[fileName] = { type: 'text', content };
            saveFileSystem();
            if (wm.activeApp.toLowerCase() === 'finder') {
                renderFinder($('#content-finder'));
            }
        }
    }

    function undo() {
        if (wm.activeApp.toLowerCase() === 'textedit' && textEditHistoryIndex > 0) {
            textEditHistoryIndex--;
            $('#text-area').val(textEditHistory[textEditHistoryIndex]);
        }
    }

    function redo() {
        if (wm.activeApp.toLowerCase() === 'textedit' && textEditHistoryIndex < textEditHistory.length - 1) {
            textEditHistoryIndex++;
            $('#text-area').val(textEditHistory[textEditHistoryIndex]);
        }
    }

    function copy() {
        const activeInput = $(document.activeElement);
        if (activeInput.is('input, textarea')) {
            try {
                activeInput[0].select();
                document.execCommand('copy');
            } catch (e) {
                alert('Copy not supported in this browser');
            }
        }
    }

    function paste() {
        const activeInput = $(document.activeElement);
        if (activeInput.is('input, textarea')) {
            try {
                navigator.clipboard.readText().then(text => {
                    activeInput.val(activeInput.val() + text);
                }).catch(() => alert('Paste not supported in this browser'));
            } catch (e) {
                alert('Paste not supported in this browser');
            }
        }
    }

    function cut() {
        const activeInput = $(document.activeElement);
        if (activeInput.is('input, textarea')) {
            try {
                activeInput[0].select();
                document.execCommand('cut');
            } catch (e) {
                alert('Cut not supported in this browser');
            }
        }
    }

    function setView(mode) {
        viewMode = mode;
        if (wm.activeApp.toLowerCase() === 'finder') {
            renderFinder($('#content-finder'));
        }
    }

    function toggleTransparency() {
        const $win = $(`.window:not(.inactive)`);
        if ($win.css('opacity') === '1') {
            $win.css('opacity', '0.8');
        } else {
            $win.css('opacity', '1');
        }
    }

    function cycleWindows() {
        const windowIds = Object.keys(wm.windows);
        if (windowIds.length < 2) return;
        const currentIndex = windowIds.indexOf(wm.activeApp.toLowerCase());
        const nextIndex = (currentIndex + 1) % windowIds.length;
        wm.setActiveWindow(windowIds[nextIndex]);
    }

    // App Implementations
    let queryCount = 0;
    const maxQueries = 10;

    function renderGrok(container) {
        container.html(`
            <div class="grok-app">
                <div class="grok-toolbar">
                    <button class="text-tool" onclick="toggleThinkMode()">Think Mode</button>
                    <button class="text-tool" onclick="toggleDeepSearch()">DeepSearch</button>
                    <button class="text-tool" onclick="startVoiceInput()"><i class="fas fa-microphone"></i></button>
                </div>
                <div class="grok-chat" id="grok-chat">
                    <div id="chat-output"></div>
                </div>
                <div class="grok-input">
                    <input type="text" id="grok-query" placeholder="Ask Grok anything...">
                    <button class="text-tool" onclick="sendGrokQuery()"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        `);
        const input = $('#grok-query');
        const output = $('#chat-output');
        const chat = $('#grok-chat');

        container.on('click', () => input.focus());

        input.on('keydown', function(e) {
            if(e.key === 'Enter') {
                sendGrokQuery();
            }
        });

        window.sendGrokQuery = async function() {
            const query = input.val().trim();
            if (!query) return;
            output.append(`<div class="grok-message user">${query}</div>`);
            input.val('');
            chat.scrollTop(chat[0].scrollHeight);
            const response = await fetchGrokResponse(query);
            output.append(`<div class="grok-message bot">${response}</div>`);
            chat.scrollTop(chat[0].scrollHeight);
        };

        window.toggleThinkMode = function() {
            output.append(`<div class="grok-message bot">Think mode enabled: Responses will be more reasoned.</div>`);
        };

        window.toggleDeepSearch = function() {
            output.append(`<div class="grok-message bot">DeepSearch mode enabled: Performing iterative search...</div>`);
        };

        window.startVoiceInput = function() {
            if (!('SpeechRecognition' in window || 'webkitSpeechRecognition' in window)) {
                output.append(`<div class="grok-message bot">Voice input not supported in this browser.</div>`);
                return;
            }
            const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                input.val(transcript);
                sendGrokQuery();
            };
            recognition.onerror = () => {
                output.append(`<div class="grok-message bot">Voice input error.</div>`);
            };
            recognition.start();
        };
    }

    async function fetchGrokResponse(query) {
        queryCount++;
        if (queryCount > maxQueries) {
            return 'Free plan limit reached. <a href="https://x.ai/grok" target="_blank">Upgrade to SuperGrok</a>';
        }
        await new Promise(resolve => setTimeout(resolve, 1000));
        return `This is a simulated response to: "${query}". Integrate with xAI API for real functionality.`;
    }

    function renderFinder(container) {
        container.html(`
            <div class="finder-layout">
                <div class="finder-sidebar">
                    <div style="font-size:10px; color:#888; padding-left:10px; margin-top:10px;">Favorites</div>
                    <div class="sidebar-item" onclick="navFinder(['Desktop'])"><i class="fas fa-desktop"></i> Desktop</div>
                    <div class="sidebar-item" onclick="navFinder(['Documents'])"><i class="fas fa-file-alt"></i> Documents</div>
                    <div class="sidebar-item" onclick="navFinder(['Downloads'])"><i class="fas fa-download"></i> Downloads</div>
                </div>
                <div class="finder-main">
                    <div style="margin-bottom:10px; color:#888; font-size:12px;"><i class="fas fa-chevron-left"></i> <i class="fas fa-chevron-right"></i> &nbsp; ${currentPath.join(' > ')}</div>
                    <div class="${viewMode === 'grid' ? 'finder-grid' : 'finder-list'}" id="finder-grid"></div>
                </div>
            </div>
        `);
        updateFinderGrid();
    }

    window.navFinder = function(path) {
        currentPath = path;
        renderFinder($('#content-finder'));
    }

    function updateFinderGrid() {
        const grid = $('#finder-grid');
        grid.empty();
        let target = fileSystem;
        currentPath.forEach(p => target = target[p] ? target[p].children : target);
        if(!target) return;
        Object.keys(target).forEach(key => {
            const item = target[key];
            let icon = 'fa-folder folder';
            if(item.type === 'text') icon = 'fa-file-alt text';
            if(item.type === 'img') icon = 'fa-file-image img';
            const el = $(`
                <div class="file-item ${viewMode === 'list' ? 'list-view' : ''}">
                    <i class="fas ${icon} file-icon ${viewMode === 'list' ? 'list-view' : ''}"></i>
                    <div class="file-name">${key}</div>
                </div>
            `);
            el.on('click', function() {
                $('.file-item').removeClass('selected');
                $(this).addClass('selected');
            });
            el.on('dblclick', () => {
                if(item.type === 'folder') {
                    currentPath.push(key);
                    renderFinder($('#content-finder'));
                } else if (item.type === 'text') {
                    wm.openApp('textedit');
                    setTimeout(() => $('#text-area').val(item.content), 200);
                }
            });
            grid.append(el);
        });
    }

    function renderTerminal(container) {
        container.html(`
            <div class="terminal-app" id="term-output">
                <div class="term-line">Last login: ${new Date().toLocaleString()} on ttys000</div>
                <div class="term-line">macOS Web Edition [Version 1.0]</div>
                <br>
                <div id="term-history"></div>
                <div class="term-input-line">
                    <span class="term-prompt">guest@macbook ~ %</span>
                    <input type="text" id="term-input" autocomplete="off" autofocus>
                </div>
            </div>
        `);
        const history = $('#term-history');
        const input = $('#term-input');
        const output = $('#term-output');
        container.on('click', () => input.focus());
        input.on('keydown', function(e) {
            if(e.key === 'Enter') {
                const cmd = this.value.trim();
                history.append(`<div class="term-line"><span class="term-prompt">guest@macbook ~ %</span> ${cmd}</div>`);
                this.value = '';
                processCommand(cmd);
                output.scrollTop(output[0].scrollHeight);
            }
        });
        function processCommand(cmd) {
            const args = cmd.split(' ');
            let response = '';
            switch(args[0].toLowerCase()) {
                case 'help': response = 'Available commands: help, clear, ls, whoami, date, echo, matrix'; break;
                case 'clear': history.empty(); return;
                case 'ls': response = Object.keys(fileSystem).join(' '); break;
                case 'whoami': response = 'guest'; break;
                case 'date': response = new Date().toString(); break;
                case 'echo': response = args.slice(1).join(' '); break;
                case 'sudo': response = 'Password: 🔑 (Just kidding, you have no power here)'; break;
                case 'matrix': startMatrix(); return;
                case '': return;
                default: response = `zsh: command not found: ${args[0]}`;
            }
            history.append(`<div class="term-line">${response}</div>`);
        }
        function startMatrix() {
            $('.terminal-app').css({'color':'#0f0', 'background':'black'}).html('<canvas id="matrix" style="position:absolute;top:0;left:0;"></canvas>');
            const C = document.getElementById("matrix");
            const $p = C.parentElement; C.width=$p.clientWidth; C.height=$p.clientHeight;
            const ctx=C.getContext("2d");
            const txts = "01"; const msg = txts.split("");
            const font_size = 10; const columns = C.width/font_size; const drops = [];
            for(let x=0; x<columns; x++) drops[x]=1;
            function draw(){
                ctx.fillStyle="rgba(0, 0, 0, 0.05)"; ctx.fillRect(0,0,C.width,C.height);
                ctx.fillStyle="#0F0"; ctx.font = font_size + "px monospace";
                for(let i=0; i<drops.length; i++){
                    const text = msg[Math.floor(Math.random()*msg.length)];
                    ctx.fillText(text, i*font_size, drops[i]*font_size);
                    if(drops[i]*font_size > C.height && Math.random() > 0.975) drops[i]=0;
                    drops[i]++;
                }
            }
            setInterval(draw, 33);
        }
    }

    function renderTextEdit(container) {
        container.html(`
            <div class="textedit-app">
                <div class="text-toolbar">
                    <select class="text-tool"><option>Helvetica</option><option>Courier</option><option>Times</option></select>
                    <select class="text-tool"><option>12</option><option>14</option><option>18</option></select>
                    <button class="text-tool"><i class="fas fa-bold"></i></button>
                    <button class="text-tool"><i class="fas fa-italic"></i></button>
                </div>
                <textarea id="text-area" placeholder="Start typing..."></textarea>
            </div>
        `);
        $('#text-area').on('input', function() {
            if (textEditHistoryIndex < textEditHistory.length - 1) {
                textEditHistory = textEditHistory.slice(0, textEditHistoryIndex + 1);
            }
            textEditHistory.push(this.value);
            textEditHistoryIndex++;
        });
    }

    let canvas, ctx, painting = false;
    function renderPaint(container) {
        container.html(`
            <div class="paint-app">
                <div class="paint-toolbar">
                    <input type="color" id="p-color" value="#000000">
                    <input type="range" id="p-size" min="1" max="50" value="5" title="Brush Size">
                    <button class="text-tool" onclick="clearCanvas()"><i class="fas fa-trash"></i> Clear</button>
                    <button class="text-tool" id="p-eraser"><i class="fas fa-eraser"></i></button>
                </div>
                <div style="flex:1; overflow:hidden; position:relative;">
                    <canvas id="paint-canvas"></canvas>
                </div>
            </div>
        `);
        setTimeout(initCanvas, 100);
    }

    function initCanvas() {
        canvas = document.getElementById('paint-canvas');
        if(!canvas) return;
        ctx = canvas.getContext('2d');
        resizeCanvas();
        let color = '#000000';
        let size = 5;
        let mode = 'draw';
        $('#p-color').on('change', function() { color = this.value; mode='draw'; });
        $('#p-size').on('input', function() { size = this.value; });
        $('#p-eraser').on('click', function() { mode = 'erase'; });
        function startPosition(e) {
            painting = true;
            draw(e);
        }
        function finishedPosition() {
            painting = false;
            ctx.beginPath();
        }
        function draw(e) {
            if (!painting) return;
            const rect = canvas.getBoundingClientRect();
            ctx.lineWidth = size;
            ctx.lineCap = 'round';
            ctx.strokeStyle = mode === 'erase' ? '#ffffff' : color;
            ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
        }
        canvas.addEventListener('mousedown', startPosition);
        canvas.addEventListener('mouseup', finishedPosition);
        canvas.addEventListener('mousemove', draw);
    }

    window.resizeCanvas = function() {
        if(!canvas) return;
        const parent = canvas.parentElement;
        const imgData = ctx.getImageData(0,0,canvas.width, canvas.height);
        canvas.width = parent.clientWidth;
        canvas.height = parent.clientHeight;
        ctx.fillStyle = "white"; ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.putImageData(imgData, 0,0);
    }
    window.clearCanvas = function() {
        ctx.fillStyle = "white"; ctx.fillRect(0, 0, canvas.width, canvas.height);
    }

    function renderCalculator(container) {
        container.html(`
            <div class="calc-app">
                <input type="text" id="calc-display" value="0" readonly>
                <div class="calc-grid">
                    <button class="calc-btn c-top" onclick="calcClear()">AC</button>
                    <button class="calc-btn c-top">+/-</button>
                    <button class="calc-btn c-top">%</button>
                    <button class="calc-btn c-op" onclick="calcOp('/')">÷</button>
                    <button class="calc-btn c-num" onclick="calcNum(7)">7</button>
                    <button class="calc-btn c-num" onclick="calcNum(8)">8</button>
                    <button class="calc-btn c-num" onclick="calcNum(9)">9</button>
                    <button class="calc-btn c-op" onclick="calcOp('*')">×</button>
                    <button class="calc-btn c-num" onclick="calcNum(4)">4</button>
                    <button class="calc-btn c-num" onclick="calcNum(5)">5</button>
                    <button class="calc-btn c-num" onclick="calcNum(6)">6</button>
                    <button class="calc-btn c-op" onclick="calcOp('-')">−</button>
                    <button class="calc-btn c-num" onclick="calcNum(1)">1</button>
                    <button class="calc-btn c-num" onclick="calcNum(2)">2</button>
                    <button class="calc-btn c-num" onclick="calcNum(3)">3</button>
                    <button class="calc-btn c-op" onclick="calcOp('+')">+</button>
                    <button class="calc-btn c-num c-zero" onclick="calcNum(0)">0</button>
                    <button class="calc-btn c-num">.</button>
                    <button class="calc-btn c-op" onclick="calcEq()">=</button>
                </div>
            </div>
        `);
    }
    
    let calcCur = '0', calcPrev = null, calcOper = null, newNum = true;
    const updateDisp = () => $('#calc-display').val(calcCur);
    window.calcNum = (num) => {
        if(newNum) { calcCur = num.toString(); newNum = false; } else { calcCur = calcCur === '0' ? num.toString() : calcCur + num; }
        updateDisp();
    };
    window.calcOp = (op) => { calcPrev = parseFloat(calcCur); calcOper = op; newNum = true; };
    window.calcClear = () => { calcCur='0'; calcPrev=null; calcOper=null; newNum=true; updateDisp(); };
    window.calcEq = () => {
        if(calcOper && !newNum) {
            const cur = parseFloat(calcCur);
            switch(calcOper){
                case '+': calcCur = calcPrev + cur; break;
                case '-': calcCur = calcPrev - cur; break;
                case '*': calcCur = calcPrev * cur; break;
                case '/': calcCur = calcPrev / cur; break;
            }
            calcOper = null; newNum = true; updateDisp();
        }
    };

    function renderSafari(container) {
        container.html(`
            <div class="safari-app">
                <div class="safari-bar">
                    <i class="fas fa-chevron-left" style="color:#888;"></i>
                    <i class="fas fa-chevron-right" style="color:#888;"></i>
                    <i class="fas fa-redo" style="color:#555; font-size:12px;"></i>
                    <input type="text" class="url-bar" value="en.wikipedia.org/wiki/MacOS" id="safari-url">
                    <i class="fas fa-share-square" style="color:#555;"></i>
                </div>
                <iframe src="https://en.wikipedia.org/wiki/MacOS" class="safari-frame" id="safari-frame" sandbox="allow-scripts allow-same-origin"></iframe>
            </div>
        `);
        $('#safari-url').on('keypress', function(e) {
            if(e.which == 13) {
                let url = this.value;
                if(!url.startsWith('http')) url = 'https://' + url;
                try {
                    $('#safari-frame').attr('src', url);
                } catch (e) {
                    alert('Invalid URL');
                }
            }
        });
    }

    function renderStudio(container) {
        container.html(`
            <div class="studio-app">
                <div class="video-stage">
                    <div id="vid-placeholder" style="width:80%; height:80%; background:linear-gradient(45deg, #ff00cc, #3333ff); animation: hue 5s infinite linear; display:flex; justify-content:center; align-items:center; color:white; font-weight:bold; font-size:20px; transition:filter 0.3s;">NO SIGNAL</div>
                    <style>@keyframes hue { 0%{filter: hue-rotate(0deg);} 100%{filter: hue-rotate(360deg);} }</style>
                </div>
                <div class="studio-controls">
                    <div class="filters-row">
                        <div style="color:#888; font-size:10px; align-self:center;">Filters:</div>
                        <button class="filter-btn" onclick="applyFilter('none')">Normal</button>
                        <button class="filter-btn" onclick="applyFilter('grayscale(1)')">B&W</button>
                        <button class="filter-btn" onclick="applyFilter('sepia(1)')">Sepia</button>
                        <button class="filter-btn" onclick="applyFilter('blur(5px)')">Blur</button>
                        <button class="filter-btn" onclick="applyFilter('invert(1)')">Invert</button>
                    </div>
                    <div class="playback-row">
                        <i class="fas fa-backward"></i>
                        <i class="fas fa-play" id="play-btn" style="font-size:20px; color:white; cursor:pointer;"></i>
                        <i class="fas fa-forward"></i>
                    </div>
                    <div style="height:3px; background:#333; margin-top:5px;"><div style="width:40%; height:100%; background:var(--accent);"></div></div>
                </div>
            </div>
        `);
        let playing = true;
        $('#play-btn').on('click', function() {
            playing = !playing;
            $(this).toggleClass('fa-play fa-pause');
            $('#vid-placeholder').css('animation-play-state', playing ? 'running' : 'paused');
        });
    }
    window.applyFilter = function(filter) {
        $('#vid-placeholder').css('filter', filter === 'none' ? '' : filter + ' hue-rotate(0deg)');
        if(filter !== 'none') $('#vid-placeholder').css('animation', 'none');
    }

    function renderSettings(container) {
        container.html(`
            <div class="settings-app">
                <div style="display:flex; align-items:center; gap:15px; width:100%; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:15px;">
                    <div style="width:60px; height:60px; background:#ccc; border-radius:50%; display:flex; justify-content:center; align-items:center; font-size:30px; color:#555;"><i class="fas fa-user"></i></div>
                    <div><div style="font-weight:600; font-size:16px;">Guest User</div><div style="font-size:12px; color:#aaa;">Apple ID, iCloud, Media & App Store</div></div>
                </div>
                <div style="align-self:flex-start; font-weight:600;">Wallpaper</div>
                <div class="wall-grid">
                    <div class="wall-thumb selected" style="background: linear-gradient(200deg, #a729f5, #5823d6, #092775, #1d6f9c);" onclick="changeWall(this)"></div>
                    <div class="wall-thumb" style="background: linear-gradient(45deg, #ff9a9e 0%, #fad0c4 99%, #fad0c4 100%);" onclick="changeWall(this)"></div>
                    <div class="wall-thumb" style="background: url('https://source.unsplash.com/random/800x600?nature,mountain'); background-size:cover;" onclick="changeWall(this)"><span>Ext (Unsplash)</span></div>
                    <div class="wall-thumb" style="background: #000;" onclick="changeWall(this)"></div>
                </div>
                <input type="file" id="wall-upload" accept="image/*" onchange="uploadWallpaper(this)" style="margin-top: 10px;">
            </div>
        `);
    }
    window.changeWall = function(el) {
        $('.wall-thumb').removeClass('selected');
        $(el).addClass('selected');
        $('body').css('background', $(el).css('background'));
    }
    window.uploadWallpaper = function(input) {
        const file = input.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                $('body').css('background', `url(${e.target.result}) no-repeat center/cover`);
            };
            reader.readAsDataURL(file);
        }
    }

    // Infrastructure
    function updateClock() {
        const now = new Date();
        const dateStr = now.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
        const timeStr = now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
        $('#clock').text(`${dateStr} ${timeStr}`);
    }
    setInterval(updateClock, 1000);
    updateClock();

    if ('getBattery' in navigator) {
        navigator.getBattery().then(battery => {
            $('#battery-level').text(Math.round(battery.level * 100) + '%');
        });
    }

    $(window).on('load', () => {
        $('.loading-progress').css('width', '100%');
        setTimeout(() => {
            $('#boot-screen').fadeOut(500, function(){ $(this).remove(); });
            setTimeout(() => wm.openApp('finder'), 600);
        }, 3200);
    });
</script>
</body>
</html>
